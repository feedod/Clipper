<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width,initial-scale=1.0,viewport-fit=cover"
    />
    <meta name="color-scheme" content="light" />
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    <script src="https://unpkg.com/ky@1.7.5/distribution/index.min.js"></script>
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/alpinejs@3.14.8/dist/cdn.min.js"
    ></script>
    <style type="text/tailwindcss">
      @theme {
        --color-bg: #ffffff;
        --color-surface: #f8f8f8;
        --color-border: #ebebeb;
        --color-text: #000000;
        --color-muted: #8e8e93;
      }

      * {
        -webkit-tap-highlight-color: transparent;
        -webkit-touch-callout: none;
      }

      html,
      body {
        background: var(--color-bg);
        font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text",
          "SF Pro Display", system-ui, sans-serif;
        overscroll-behavior: none;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        text-rendering: optimizeLegibility;
      }

      body {
        padding: env(safe-area-inset-top) env(safe-area-inset-right)
          env(safe-area-inset-bottom) env(safe-area-inset-left);
      }

      ::-webkit-scrollbar {
        display: none;
      }

      input {
        font-size: 16px;
        caret-color: var(--color-text);
      }

      input:focus {
        outline: none;
      }

      .press {
        transition: transform 80ms ease-out, opacity 80ms ease-out;
      }

      .press:active {
        transform: scale(0.97);
        opacity: 0.8;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(12px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .fade {
        animation: fadeIn 0.4s cubic-bezier(0.25, 1, 0.5, 1) both;
      }
    </style>
  </head>
  <body
    x-data="App"
    class="flex min-h-dvh flex-col select-none bg-bg text-text"
  >
    <main class="mx-auto flex w-full max-w-md flex-1 flex-col px-5 pb-32">
      <header class="fade pb-8 pt-10 text-center">
        <h1 class="text-3xl font-bold tracking-tight">Clipper</h1>
        <p class="mt-2 text-sm text-muted" x-text="statusText"></p>
      </header>

      <section class="fade space-y-3" style="animation-delay: 50ms">
        <div class="relative">
          <div
            class="pointer-events-none absolute left-4 top-1/2 -translate-y-1/2 text-muted"
          >
            <i data-lucide="link" class="h-5 w-5"></i>
          </div>
          <input
            type="url"
            x-ref="input"
            x-model="url"
            @input.debounce.100ms="detect"
            @paste="$nextTick(() => detect())"
            @keydown.enter.prevent="download"
            :disabled="loading"
            placeholder="Вставьте ссылку на видео"
            autocomplete="off"
            autocorrect="off"
            autocapitalize="off"
            spellcheck="false"
            enterkeyhint="go"
            class="h-14 w-full rounded-2xl border border-border bg-surface pl-12 pr-12 text-text transition-colors placeholder:text-muted focus:border-text/20 disabled:opacity-40"
          />
          <button
            x-show="url.length"
            x-transition.opacity.duration.100ms
            @click="clear"
            :disabled="loading"
            class="press absolute right-3 top-1/2 grid h-8 w-8 -translate-y-1/2 place-items-center rounded-full bg-border text-muted disabled:opacity-40"
            type="button"
          >
            <i data-lucide="x" class="h-4 w-4"></i>
          </button>
        </div>

        <button
          x-show="platform && !loading && !video"
          x-transition.opacity.duration.150ms
          @click="download"
          :disabled="loading"
          :style="{ backgroundColor: platform?.colors?.primary }"
          class="press flex h-14 w-full items-center justify-center gap-2.5 rounded-2xl font-semibold text-white disabled:opacity-40"
          type="button"
        >
          <i data-lucide="download" class="h-5 w-5"></i>
          <span>Сохранить видео</span>
        </button>
      </section>

      <template x-if="loading">
        <section class="fade flex flex-1 flex-col items-center justify-center py-20">
          <div class="mb-6 w-full max-w-60">
            <div class="mb-3 flex items-center justify-between">
              <span class="text-sm font-semibold">Загрузка</span>
              <span class="text-sm font-semibold" x-text="`${progress}%`"></span>
            </div>
            <div class="h-2 overflow-hidden rounded-full border border-border bg-surface">
              <div
                class="h-full rounded-full transition-all duration-200 ease-out"
                :style="{ backgroundColor: platform?.colors?.progress, width: `${progress}%` }"
              ></div>
            </div>
          </div>
          <p class="text-sm text-muted" x-text="loadingText"></p>
        </section>
      </template>

      <template x-if="error && !loading">
        <section class="fade mt-6 rounded-2xl border border-red-100 bg-red-50 p-4">
          <div class="flex items-start gap-3">
            <div class="grid h-10 w-10 shrink-0 place-items-center rounded-full bg-red-100 text-red-500">
              <i data-lucide="alert-circle" class="h-5 w-5"></i>
            </div>
            <div class="min-w-0 flex-1 pt-0.5">
              <p class="text-sm font-semibold text-red-600">Ошибка</p>
              <p class="mt-0.5 text-sm text-red-500" x-text="error"></p>
            </div>
          </div>
        </section>
      </template>

      <template x-if="video && !loading">
        <section class="fade mt-6 space-y-4">
          <div class="overflow-hidden rounded-2xl border border-border bg-surface">
            <div class="relative aspect-[9/16] w-full bg-black">
              <video
                :src="video.play"
                :poster="video.cover"
                class="absolute inset-0 h-full w-full object-contain"
                controls
                playsinline
                x-init="$el.setAttribute('webkit-playsinline', '')"
              ></video>
              <div class="absolute left-3 top-3 flex items-center gap-1.5 rounded-lg bg-white/95 px-2.5 py-1.5 shadow-sm backdrop-blur-sm">
                <div
                  class="h-4 w-4"
                  :style="{ color: platform?.colors?.icon }"
                  x-html="platform?.iconSvg"
                ></div>
                <span class="text-xs font-semibold" x-text="platform?.name"></span>
              </div>
              <div
                x-show="video.duration"
                class="absolute right-3 top-3 rounded-lg bg-white/95 px-2.5 py-1.5 shadow-sm backdrop-blur-sm"
              >
                <span class="text-xs font-semibold" x-text="formatTime(video.duration)"></span>
              </div>
            </div>
          </div>

          <div class="flex items-center gap-3 rounded-2xl border border-border bg-surface p-4">
            <img
              :src="video.author?.avatar || PLACEHOLDER.avatar"
              :alt="video.author?.nickname"
              @error="$el.src = PLACEHOLDER.avatar"
              class="h-12 w-12 rounded-full border border-border object-cover"
            />
            <div class="min-w-0 flex-1">
              <p class="truncate font-semibold" x-text="video.author?.nickname || 'Автор'"></p>
              <p
                x-show="video.author?.unique_id"
                class="truncate text-sm text-muted"
                x-text="`@${video.author?.unique_id}`"
              ></p>
            </div>
            <div
              class="h-5 w-5"
              :style="{ color: platform?.colors?.icon }"
              x-html="platform?.iconSvg"
            ></div>
          </div>

          <p
            x-show="video.title"
            class="line-clamp-2 px-1 text-sm leading-relaxed"
            x-text="video.title"
          ></p>

          <template x-if="visibleStats.length">
            <div
              class="grid gap-2 rounded-2xl border border-border bg-surface p-3"
              :class="`grid-cols-${visibleStats.length}`"
            >
              <template x-for="stat in visibleStats" :key="stat.key">
                <div class="py-2 text-center">
                  <div
                    class="mx-auto grid h-9 w-9 place-items-center rounded-full"
                    :style="{ backgroundColor: platform?.colors?.statsBg, color: platform?.colors?.statsIcon }"
                  >
                    <i :data-lucide="stat.icon" class="h-4 w-4"></i>
                  </div>
                  <p class="mt-1 text-sm font-semibold" x-text="formatNumber(video[stat.key])"></p>
                  <p class="mt-0.5 text-[10px] text-muted" x-text="stat.label"></p>
                </div>
              </template>
            </div>
          </template>

          <div class="grid grid-cols-2 gap-3 pt-2">
            <button
              @click="saveVideo"
              :style="{ backgroundColor: platform?.colors?.save }"
              class="press flex h-14 items-center justify-center gap-2 rounded-2xl font-semibold text-white"
              type="button"
            >
              <i data-lucide="download" class="h-5 w-5"></i>
              <span>Сохранить</span>
            </button>
            <button
              @click="shareStory"
              :style="{ backgroundColor: platform?.colors?.story }"
              class="press flex h-14 items-center justify-center gap-2 rounded-2xl font-semibold text-white"
              type="button"
            >
              <i data-lucide="plus-circle" class="h-5 w-5"></i>
              <span>В историю</span>
            </button>
          </div>
        </section>
      </template>

      <template x-if="history.length && !loading">
        <section class="fade mt-8" style="animation-delay: 100ms">
          <div class="mb-4 flex items-center justify-between">
            <div class="flex items-center gap-2 text-muted">
              <i data-lucide="clock" class="h-5 w-5"></i>
              <h2 class="font-semibold text-text">Недавние</h2>
            </div>
            <button @click="clearHistory" class="press text-sm text-muted" type="button">
              Очистить
            </button>
          </div>
          <div class="-mx-5 flex gap-3 overflow-x-auto px-5 pb-2 [scrollbar-width:none]">
            <template x-for="item in history" :key="item.id">
              <button @click="loadHistory(item)" class="press w-22 shrink-0" type="button">
                <div class="relative mb-2 h-30 w-22 overflow-hidden rounded-xl border border-border">
                  <img
                    :src="item.cover"
                    alt=""
                    @error="$el.src = PLACEHOLDER.cover"
                    class="h-full w-full object-cover"
                    loading="lazy"
                    decoding="async"
                  />
                  <div class="absolute inset-x-0 bottom-0 h-12 bg-gradient-to-t from-black/60 to-transparent"></div>
                  <div class="absolute bottom-2 left-2 grid h-5 w-5 place-items-center rounded-full bg-white">
                    <div
                      class="h-3 w-3"
                      :style="{ color: getPlatform(item.platform)?.colors?.icon }"
                      x-html="getPlatform(item.platform)?.iconSvg"
                    ></div>
                  </div>
                </div>
                <p class="truncate text-left text-xs text-muted" x-text="item.author"></p>
              </button>
            </template>
          </div>
        </section>
      </template>

      <footer
        class="fade mt-auto pt-12"
        style="animation-delay: 150ms"
        x-show="!loading && !video"
      >
        <p class="mb-4 text-center text-sm text-muted">Поддерживаемые платформы</p>
        <div class="flex flex-wrap justify-center gap-3">
          <template x-for="p in platforms" :key="p.name">
            <div class="flex items-center gap-2.5 rounded-xl border border-border bg-surface px-5 py-3">
              <div class="h-5 w-5" :style="{ color: p.colors?.icon }" x-html="p.iconSvg"></div>
              <span class="text-sm font-semibold" x-text="p.name"></span>
            </div>
          </template>
        </div>
      </footer>
    </main>

    <script>
      const PLACEHOLDER = Object.freeze({
        avatar: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 48 48'%3E%3Crect fill='%23e5e5e5' width='48' height='48'/%3E%3C/svg%3E",
        cover: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 88 120'%3E%3Crect fill='%23e5e5e5' width='88' height='120'/%3E%3C/svg%3E",
      });

      const CONFIG = Object.freeze({
        timeout: 15000,
        progressInterval: 100,
        progressStep: { min: 2, max: 10 },
        progressLimit: 95,
        historyLimit: 20,
        storageKey: "clipper_history",
      });

      const PLATFORMS = Object.freeze([
        {
          name: "TikTok",
          patterns: [
            /tiktok\.com\/@[\w.-]+\/video\/\d+/i,
            /tiktok\.com\/t\/[\w-]+/i,
            /vm\.tiktok\.com\/[\w-]+/i,
            /vt\.tiktok\.com\/[\w-]+/i,
          ],
          colors: {
            primary: "#fe2c55",
            progress: "#000000",
            icon: "#000000",
            save: "#fe2c55",
            story: "#000000",
            statsBg: "#fe2c5520",
            statsIcon: "#fe2c55",
          },
          iconSvg: `<svg viewBox="0 0 24 24" fill="currentColor" class="h-full w-full"><path d="M19.59 6.69a4.83 4.83 0 0 1-3.77-4.25V2h-3.45v13.67a2.89 2.89 0 0 1-5.2 1.74 2.89 2.89 0 0 1 2.31-4.64c.29 0 .58.04.88.13V9.4a6.33 6.33 0 0 0-5.36 10.69A6.34 6.34 0 0 0 15.86 15.67v-7a8.16 8.16 0 0 0 4.77 1.52v-3.4c-.35-.05-.7-.08-1.04-.1z"/></svg>`,
          stats: [
            { key: "play_count", label: "Просмотры", icon: "play" },
            { key: "digg_count", label: "Лайки", icon: "heart" },
            { key: "comment_count", label: "Комменты", icon: "message-circle" },
            { key: "share_count", label: "Репосты", icon: "share-2" },
          ],
          endpoint: "https://www.tikwm.com/api/",
          async fetch(url, signal) {
            const response = await ky.post(this.endpoint, {
              body: new URLSearchParams({ url, hd: 1 }),
              signal,
              timeout: CONFIG.timeout,
            }).json();

            if (response?.code !== 0 || !response?.data?.play) {
              throw new Error("Видео недоступно или не найдено");
            }

            return response.data;
          },
        },
      ]);

      const Telegram = {
        app: window.Telegram?.WebApp,

        init() {
          if (!this.app) return;
          this.app.ready();
          this.app.expand();
          this.app.setHeaderColor?.("#ffffff");
          this.app.setBackgroundColor?.("#ffffff");
        },

        haptic(type = "light") {
          this.app?.HapticFeedback?.impactOccurred?.(type);
        },

        notify(type) {
          this.app?.HapticFeedback?.notificationOccurred?.(type);
        },

        download(url, filename) {
          return this.app?.downloadFile?.({ url, file_name: filename }) ?? false;
        },

        shareStory(mediaUrl, text) {
          if (!this.app?.shareToStory) return false;
          this.app.shareToStory(mediaUrl, {
            text,
            widget_link: { url: "https://t.me/ClipperAppBot", name: "Clipper" },
          });
          return true;
        },
      };

      const Storage = {
        get() {
          try {
            return JSON.parse(localStorage.getItem(CONFIG.storageKey)) ?? [];
          } catch {
            return [];
          }
        },

        set(data) {
          try {
            localStorage.setItem(CONFIG.storageKey, JSON.stringify(data));
          } catch {}
        },

        add(item) {
          const list = this.get().filter((i) => i.id !== item.id);
          list.unshift(item);
          this.set(list.slice(0, CONFIG.historyLimit));
        },

        clear() {
          try {
            localStorage.removeItem(CONFIG.storageKey);
          } catch {}
        },
      };

      window.PLACEHOLDER = PLACEHOLDER;

      document.addEventListener("alpine:init", () => {
        Alpine.data("App", () => ({
          url: "",
          platform: null,
          platforms: PLATFORMS,
          loading: false,
          progress: 0,
          video: null,
          error: null,
          history: [],
          progressTimer: null,

          get statusText() {
            if (this.loading) return "Загрузка видео...";
            if (this.error) return "Попробуйте другую ссылку";
            if (this.video) return "Видео готово к сохранению";
            if (this.platform) return `${this.platform.name} видео найдено`;
            return "Сохраняйте видео легко и быстро";
          },

          get loadingText() {
            if (this.progress < 30) return "Подключение...";
            if (this.progress < 60) return "Получение видео...";
            if (this.progress < 90) return "Обработка...";
            return "Почти готово...";
          },

          get visibleStats() {
            if (!this.platform?.stats || !this.video) return [];
            return this.platform.stats.filter((s) => this.video[s.key] > 0);
          },

          init() {
            Telegram.init();
            this.history = Storage.get();
            this.$nextTick(() => lucide.createIcons());
          },

          formatTime(seconds) {
            if (!seconds) return "0:00";
            const m = Math.floor(seconds / 60);
            const s = Math.floor(seconds % 60);
            return `${m}:${String(s).padStart(2, "0")}`;
          },

          formatNumber(num) {
            if (!num) return "0";
            if (num >= 1e6) return `${(num / 1e6).toFixed(1)}M`;
            if (num >= 1e3) return `${(num / 1e3).toFixed(1)}K`;
            return String(num);
          },

          getPlatform(name) {
            return PLATFORMS.find((p) => p.name === name);
          },

          detect() {
            this.error = null;
            this.platform = PLATFORMS.find((p) =>
              p.patterns.some((r) => r.test(this.url))
            ) ?? null;

            if (this.platform) Telegram.haptic("light");
          },

          clear() {
            this.url = "";
            this.platform = null;
            this.video = null;
            this.error = null;
            Telegram.haptic("light");
          },

          startProgress() {
            this.stopProgress();
            this.progressTimer = setInterval(() => {
              const { min, max } = CONFIG.progressStep;
              const step = Math.floor(Math.random() * (max - min + 1)) + min;
              this.progress = Math.min(this.progress + step, CONFIG.progressLimit);
            }, CONFIG.progressInterval);
          },

          stopProgress() {
            if (this.progressTimer) {
              clearInterval(this.progressTimer);
              this.progressTimer = null;
            }
          },

          async download() {
            if (!this.platform || this.loading) return;

            this.$refs.input?.blur();
            this.loading = true;
            this.progress = 0;
            this.error = null;
            this.video = null;

            Telegram.haptic("medium");
            this.startProgress();

            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), CONFIG.timeout);

            try {
              this.video = await this.platform.fetch(this.url, controller.signal);
              this.progress = 100;

              Storage.add({
                id: this.video.id ?? Date.now(),
                cover: this.video.cover,
                author: this.video.author?.nickname ?? "Автор",
                url: this.url,
                platform: this.platform.name,
              });

              this.history = Storage.get();
              Telegram.notify("success");
            } catch (err) {
              this.error = err.name === "AbortError"
                ? "Превышено время ожидания"
                : err.message || "Не удалось загрузить видео";
              Telegram.notify("error");
            } finally {
              clearTimeout(timeoutId);
              this.stopProgress();
              this.loading = false;
              this.$nextTick(() => lucide.createIcons());
            }
          },

          saveVideo() {
            if (!this.video?.play) return;

            const filename = `${this.platform.name.toLowerCase()}_${this.video.id ?? Date.now()}.mp4`;
            const success = Telegram.download(this.video.play, filename);

            if (success) {
              Telegram.notify("success");
            } else {
              this.error = "Скачивание доступно только в Telegram";
              Telegram.notify("error");
            }
          },

          shareStory() {
            if (!this.video?.play) return;

            const text = this.video.title?.trim()
              ? `${this.video.title.trim()}\n\n@ClipperAppBot`
              : "@ClipperAppBot";

            const success = Telegram.shareStory(this.video.play, text);

            if (success) {
              Telegram.notify("success");
            } else {
              this.error = "Истории доступны только в Telegram";
              Telegram.notify("error");
            }
          },

          loadHistory(item) {
            const platform = this.getPlatform(item.platform);

            if (!platform) {
              this.error = "Платформа больше не поддерживается";
              Telegram.notify("error");
              return;
            }

            this.url = item.url;
            this.platform = platform;
            Telegram.haptic("light");
            this.download();
          },

          clearHistory() {
            Storage.clear();
            this.history = [];
            Telegram.haptic("medium");
          },
        }));
      });

      document.addEventListener("DOMContentLoaded", () => lucide.createIcons());
    </script>
  </body>
</html>