<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#1a1a1a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Clipper">
    <title>Clipper - Скачивание видео</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.14.8/dist/cdn.min.js"></script>

    <style>
        /**
         * ==========================================
         * ПЕРЕМЕННЫЕ ТЕМЫ TELEGRAM
         * ==========================================
         */
        :root {
            --tg-theme-bg-color: #1a1a1a;
            --tg-theme-text-color: #ffffff;
            --tg-theme-hint-color: #7d7d7d;
            --tg-theme-link-color: #5eaaef;
            --tg-theme-button-color: #5eaaef;
            --tg-theme-button-text-color: #ffffff;
            --tg-theme-secondary-bg-color: #2a2a2a;

            --color-tg-bg: var(--tg-theme-bg-color);
            --color-tg-text: var(--tg-theme-text-color);
            --color-tg-hint: var(--tg-theme-hint-color);
            --color-tg-link: var(--tg-theme-link-color);
            --color-tg-btn: var(--tg-theme-button-color);
            --color-tg-btn-text: var(--tg-theme-button-text-color);
            --color-tg-secondary: var(--tg-theme-secondary-bg-color);
        }

        /**
         * ==========================================
         * СБРОС И БАЗОВЫЕ СТИЛИ
         * ==========================================
         */
        * {
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
        }

        body {
            background-color: var(--color-tg-bg);
            color: var(--color-tg-text);
        }

        /**
         * ==========================================
         * СКРЫТИЕ СКРОЛЛБАРОВ
         * ==========================================
         */
        main::-webkit-scrollbar {
            display: none;
        }

        main {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Стилизация скроллбара для качеств видео */
        .quality-scroll::-webkit-scrollbar {
            height: 4px;
        }

        .quality-scroll::-webkit-scrollbar-track {
            background: transparent;
        }

        .quality-scroll::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        .quality-scroll::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /**
         * ==========================================
         * АНИМАЦИИ
         * ==========================================
         */
        @keyframes shimmer {
            0% {
                background-position: -1000px 0;
            }
            100% {
                background-position: 1000px 0;
            }
        }

        /**
         * ==========================================
         * КОМПОНЕНТНЫЕ КЛАССЫ
         * ==========================================
         */
        .focus-glow {
            box-shadow: inset 0 0 20px rgba(94, 170, 239, 0.1);
        }

        .glass-effect {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .glass-effect-lg {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .button-primary {
            background: linear-gradient(to right, var(--color-tg-btn), rgba(94, 170, 239, 0.8));
            color: var(--color-tg-btn-text);
            box-shadow: 0 20px 25px -5px rgba(94, 170, 239, 0.5);
        }

        .button-primary:hover {
            box-shadow: 0 25px 35px -5px rgba(94, 170, 239, 0.6);
        }

        .button-secondary {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--color-tg-text);
        }

        .button-secondary:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .input-field {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 2px solid rgba(255, 255, 255, 0.1);
            color: var(--color-tg-text);
            transition: all 0.3s ease;
        }

        .input-field::placeholder {
            color: var(--color-tg-hint);
        }

        .input-field:focus {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(94, 170, 239, 0.5);
            outline: none;
            box-shadow: 0 0 0 3px rgba(94, 170, 239, 0.2);
        }

        .icon-button {
            padding: 0.5rem;
            border-radius: 0.5rem;
            transition: all 0.2s ease;
        }

        .icon-button:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .icon-button:active {
            transform: scale(0.9);
        }

        .section-title {
            font-size: 0.75rem;
            color: var(--color-tg-hint);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            font-weight: 600;
        }

        /**
         * ==========================================
         * АДАПТИВНОСТЬ
         * ==========================================
         */
        @media (max-width: 320px) {
            main {
                padding: 0.75rem;
            }
        }
    </style>
</head>

<body 
    x-data="AppManager.init()"
    @:init="initializeTelegramApp()"
    class="min-h-screen select-none antialiased overflow-x-hidden"
>
    <!-- Основной контейнер -->
    <div class="min-h-screen flex flex-col" :style="{paddingTop: safeAreaTop + 'px', paddingBottom: safeAreaBottom + 'px'}">
        
        <!-- Основное содержимое -->
        <main class="flex-1 px-4 pt-4 pb-6 space-y-5 overflow-y-auto">
            
            <!-- Секция ввода URL -->
            <section class="space-y-3">
                <div class="relative group">
                    <!-- Поле ввода с Liquid Glass дизайном -->
                    <input 
                        type="url" 
                        x-model="url"
                        @input.debounce.400ms="analyzeVideo()"
                        @paste="pasteFromClipboard"
                        class="input-field w-full px-4 py-3.5 pr-12 rounded-2xl text-base"
                        placeholder="Вставьте ссылку на видео..."
                        inputmode="url"
                        autocomplete="off"
                        autocorrect="off"
                        autocapitalize="off"
                        spellcheck="false"
                        aria-label="URL видео"
                    >
                    
                    <!-- Кнопка вставить из буфера обмена -->
                    <button 
                        @click="pasteFromClipboard()"
                        @keydown.space.enter="pasteFromClipboard()"
                        class="absolute right-3 top-1/2 -translate-y-1/2 icon-button focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-tg-bg"
                        type="button"
                        title="Вставить из буфера обмена"
                        aria-label="Вставить из буфера обмена"
                        style="color: var(--color-tg-hint); --tw-ring-color: var(--color-tg-btn);"
                    >
                        <svg class="w-5 h-5 hover:text-white transition-colors" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/>
                        </svg>
                    </button>

                    <!-- Подсвечивание при фокусе -->
                    <div class="focus-glow absolute inset-0 rounded-2xl opacity-0 group-focus-within:opacity-100 transition-opacity duration-300 pointer-events-none"></div>
                </div>

                <!-- Сообщение об ошибке URL -->
                <p 
                    x-show="urlError" 
                    x-text="urlError"
                    x-transition:enter="transition ease-out duration-200"
                    x-transition:leave="transition ease-in duration-150"
                    class="text-red-400 text-sm px-1 flex items-center gap-2"
                >
                    <svg class="w-4 h-4 shrink-0" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>
                    <span x-text="urlError"></span>
                </p>
            </section>

            <!-- Секция платформ -->
            <section class="space-y-3">
                <p class="section-title px-1">Платформы</p>
                <div class="grid grid-cols-4 gap-2.5">
                    <template x-for="platform in platforms" :key="platform.id">
                        <button 
                            @click="selectPlatform(platform.id)"
                            class="group relative py-4 px-2 rounded-2xl glass-effect flex flex-col items-center gap-2 transition-all duration-300 hover:bg-white/10 active:scale-95 focus:outline-none focus:ring-2"
                            :class="activePlatform === platform.id && 'ring-2 ring-offset-2 ring-offset-tg-bg bg-white/10'"
                            style="--tw-ring-color: var(--color-tg-btn);"
                            type="button"
                            :aria-pressed="activePlatform === platform.id"
                            :title="platform.name"
                        >
                            <!-- Платформа значок -->
                            <div class="w-9 h-9 rounded-lg flex items-center justify-center transition-transform group-hover:scale-110" :style="{background: platform.gradient}">
                                <span x-html="platform.svg" class="w-5 h-5"></span>
                            </div>
                            <span class="text-[10px] font-semibold text-center line-clamp-1" x-text="platform.name"></span>
                        </button>
                    </template>
                </div>
            </section>

            <!-- Статус загрузки -->
            <section x-show="isLoading" x-transition class="py-8">
                <div class="flex flex-col items-center gap-4">
                    <!-- Спиннер анимация -->
                    <div class="relative w-12 h-12">
                        <div class="absolute inset-0 rounded-full bg-gradient-to-r from-blue-500/50 via-blue-500/30 to-blue-500/50 animate-spin" style="background: linear-gradient(to right, rgba(94, 170, 239, 0.5), rgba(94, 170, 239, 0.3), rgba(94, 170, 239, 0.5));"></div>
                        <div class="absolute inset-1 rounded-full" style="background-color: var(--color-tg-bg);"></div>
                    </div>
                    <p class="text-sm font-medium" style="color: var(--color-tg-hint);">Получаем информацию...</p>
                </div>
            </section>

            <!-- Сообщение об ошибке анализа -->
            <section x-show="analysisError && !isLoading" x-transition>
                <div class="rounded-2xl bg-gradient-to-br from-red-500/10 to-red-600/5 backdrop-blur-md border border-red-500/20 p-4 flex items-start gap-3">
                    <div class="w-9 h-9 rounded-lg bg-red-500/20 flex items-center justify-center shrink-0">
                        <svg class="w-5 h-5 text-red-400" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                        </svg>
                    </div>
                    <div class="flex-1">
                        <p class="text-red-400 font-semibold text-sm">Ошибка анализа</p>
                        <p class="text-sm text-red-300/70 mt-1" x-text="analysisError"></p>
                        <button 
                            @click="analyzeVideo()"
                            class="text-sm font-semibold mt-3 hover:opacity-80 transition-opacity"
                            type="button"
                            style="color: var(--color-tg-link);"
                        >
                            Повторить попытку →
                        </button>
                    </div>
                </div>
            </section>

            <!-- Информация о видео -->
            <section x-show="video && !isLoading && !analysisError" x-transition>
                <!-- Миниатюра видео с градиентом -->
                <div class="rounded-3xl overflow-hidden glass-effect-lg">
                    <div class="relative aspect-video bg-gradient-to-br from-black/80 via-black/60 to-black/40">
                        <!-- Изображение миниатюры -->
                        <img 
                            :src="video.thumbnail" 
                            class="w-full h-full object-cover" 
                            alt="Видео миниатюра"
                            loading="lazy" 
                            decoding="async"
                        >
                        
                        <!-- Градиентный оверлей -->
                        <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-black/40 to-transparent"></div>
                        
                        <!-- Информация видео -->
                        <div class="absolute bottom-0 left-0 right-0 p-4 space-y-1">
                            <p class="text-white font-bold text-sm line-clamp-2" x-text="video.title"></p>
                            <p class="text-white/60 text-xs" x-text="video.author"></p>
                        </div>
                        
                        <!-- Длительность видео -->
                        <div x-show="video.duration" class="absolute top-3 right-3 bg-black/70 backdrop-blur-lg px-2.5 py-1.5 rounded-lg">
                            <span class="text-white text-xs font-semibold" x-text="video.duration"></span>
                        </div>
                    </div>
                </div>

                <!-- Выбор качества видео -->
                <div class="quality-scroll flex gap-2 mt-4 overflow-x-auto pb-2">
                    <template x-for="media in video.medias" :key="media.url">
                        <button 
                            @click="selectMedia(media)"
                            class="shrink-0 px-4 py-2.5 rounded-xl text-sm font-semibold whitespace-nowrap transition-all duration-200 active:scale-95 focus:outline-none focus:ring-2"
                            :class="selectedMedia?.url === media.url ? 'button-primary' : 'button-secondary'"
                            style="--tw-ring-color: var(--color-tg-btn); --tw-ring-offset-color: var(--color-tg-bg);"
                            x-text="formatMediaLabel(media)"
                            type="button"
                            :aria-selected="selectedMedia?.url === media.url"
                        ></button>
                    </template>
                </div>

                <!-- Прогресс загрузки -->
                <div x-show="downloadProgress > 0 && isDownloading" x-transition class="mt-4 space-y-2">
                    <div class="flex justify-between items-center text-sm">
                        <span class="font-medium" style="color: var(--color-tg-hint);">Загрузка</span>
                        <span class="font-bold" :style="{color: 'var(--color-tg-btn)'};" x-text="`${downloadProgress}%`"></span>
                    </div>
                    <div class="h-2 glass-effect rounded-full overflow-hidden">
                        <div 
                            class="h-full transition-all duration-300 ease-out rounded-full" 
                            :style="{width: downloadProgress + '%', background: 'linear-gradient(to right, var(--color-tg-btn), rgba(94, 170, 239, 0.6))'}"
                        ></div>
                    </div>
                </div>
            </section>

            <!-- История загрузок -->
            <section x-show="history.length > 0" x-transition>
                <div class="flex items-center justify-between mb-3 px-1">
                    <p class="section-title">История</p>
                    <button 
                        @click="clearHistory()"
                        class="text-xs font-semibold hover:opacity-80 transition-opacity focus:outline-none"
                        type="button"
                        style="color: var(--color-tg-link);"
                    >
                        Очистить
                    </button>
                </div>
                <div class="space-y-2.5">
                    <template x-for="historyItem in history" :key="historyItem.id">
                        <button 
                            @click="loadFromHistory(historyItem)"
                            class="w-full group rounded-2xl glass-effect p-3 flex items-center gap-3 transition-all duration-200 hover:bg-white/10 active:scale-95 focus:outline-none focus:ring-2"
                            type="button"
                            style="--tw-ring-color: var(--color-tg-btn);"
                        >
                            <!-- Миниатюра истории -->
                            <img 
                                :src="historyItem.thumbnail" 
                                class="w-12 h-12 rounded-lg object-cover shrink-0 group-hover:scale-110 transition-transform" 
                                alt="История видео"
                                loading="lazy" 
                                decoding="async"
                            >
                            <div class="flex-1 min-w-0 text-left">
                                <p class="text-sm font-semibold truncate" x-text="historyItem.title"></p>
                                <p class="text-xs mt-0.5" x-text="formatTimeAgo(historyItem.timestamp)" style="color: var(--color-tg-hint);"></p>
                            </div>
                        </button>
                    </template>
                </div>
            </section>
        </main>

        <!-- Кнопка скачивания -->
        <div class="shrink-0 px-4 py-4 pointer-events-none" style="background: linear-gradient(to top, var(--color-tg-bg), rgba(26, 26, 26, 0.8), transparent);">
            <button 
                @click="downloadVideo()"
                :disabled="!video || !selectedMedia || isDownloading"
                class="w-full pointer-events-auto py-3.5 rounded-2xl font-bold flex items-center justify-center gap-2.5 transition-all duration-200 active:scale-95 focus:outline-none focus:ring-2"
                :class="video && selectedMedia && !isDownloading 
                    ? 'button-primary' 
                    : 'button-secondary'"
                style="--tw-ring-color: var(--color-tg-btn);"
                type="button"
            >
                <!-- Иконка загрузки/стрелка -->
                <template x-if="isDownloading">
                    <div class="w-5 h-5 rounded-full border-2 border-current border-t-transparent animate-spin opacity-80"></div>
                </template>
                <template x-if="!isDownloading">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
                    </svg>
                </template>
                <span x-text="getDownloadButtonText()"></span>
            </button>
        </div>

        <!-- Toast уведомление -->
        <div 
            x-show="toast.isVisible" 
            x-transition:enter="transition ease-out duration-300"
            x-transition:enter-start="opacity-0 translate-y-8 scale-95"
            x-transition:enter-end="opacity-100 translate-y-0 scale-100"
            x-transition:leave="transition ease-in duration-200"
            x-transition:leave-start="opacity-100"
            x-transition:leave-end="opacity-0 translate-y-2"
            @click="toast.isVisible = false"
            class="fixed bottom-32 left-4 right-4 z-50 pointer-events-auto"
        >
            <div class="rounded-2xl glass-effect-lg p-4 flex items-center gap-3 shadow-2xl">
                <!-- Иконка статуса -->
                <div class="shrink-0">
                    <template x-if="toast.isSuccess">
                        <div class="w-5 h-5 rounded-full bg-green-500/30 flex items-center justify-center">
                            <svg class="w-3.5 h-3.5 text-green-400" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                            </svg>
                        </div>
                    </template>
                    <template x-if="!toast.isSuccess">
                        <div class="w-5 h-5 rounded-full bg-red-500/30 flex items-center justify-center">
                            <svg class="w-3.5 h-3.5 text-red-400" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                            </svg>
                        </div>
                    </template>
                </div>
                <p class="text-sm font-medium flex-1" x-text="toast.message"></p>
            </div>
        </div>
    </div>

    <script>
        /**
         * ==========================================
         * КОНФИГУРАЦИЯ ПРИЛОЖЕНИЯ
         * ==========================================
         */
        const API_CONFIG = {
            baseUrl: 'https://api.fastsaverapi.com',
            apiKey: 'YOUR_API_KEY_HERE',
            timeout: 30000
        };

        /**
         * ==========================================
         * КЛАСС: УПРАВЛЕНИЕ API
         * ==========================================
         */
        class APIManager {
            /**
             * Получить информацию о видео
             * @param {string} url - URL видео
             * @returns {Promise<Object>} Данные видео
             */
            static async fetchVideo(url) {
                try {
                    const response = await fetch(
                        `${API_CONFIG.baseUrl}/v1/fetch?url=${encodeURIComponent(url)}`,
                        {
                            method: 'GET',
                            headers: {
                                'x-api-key': API_CONFIG.apiKey,
                                'Accept': 'application/json'
                            },
                            signal: AbortSignal.timeout(API_CONFIG.timeout)
                        }
                    );

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(
                            errorData.message || 
                            `Ошибка сервера: ${response.status} ${response.statusText}`
                        );
                    }

                    const data = await response.json();

                    if (!data?.result) {
                        throw new Error('Не удалось получить информацию о видео');
                    }

                    return {
                        title: data.result.title || 'Без названия',
                        author: data.result.author || 'Неизвестный автор',
                        duration: data.result.duration || '',
                        thumbnail: data.result.thumbnail || '',
                        medias: Array.isArray(data.result.medias) ? data.result.medias : []
                    };
                } catch (error) {
                    if (error.name === 'AbortError') {
                        throw new Error('Превышено время ожидания');
                    }
                    throw error;
                }
            }
        }

        /**
         * ==========================================
         * КЛАСС: УПРАВЛЕНИЕ ИСТОРИЕЙ
         * ==========================================
         */
        class HistoryManager {
            static STORAGE_KEY = 'clipper_history';
            static MAX_ITEMS = 10;

            /**
             * Загрузить историю из localStorage
             * @returns {Array} Массив элементов истории
             */
            static load() {
                try {
                    const saved = localStorage.getItem(this.STORAGE_KEY);
                    return saved ? JSON.parse(saved) : [];
                } catch {
                    return [];
                }
            }

            /**
             * Сохранить элемент в историю
             * @param {Object} item - Элемент для сохранения
             */
            static save(item) {
                try {
                    const history = this.load();
                    const filtered = history.filter(h => h.url !== item.url);
                    const updated = [item, ...filtered].slice(0, this.MAX_ITEMS);
                    localStorage.setItem(this.STORAGE_KEY, JSON.stringify(updated));
                } catch (error) {
                    console.error('Ошибка при сохранении истории:', error);
                }
            }

            /**
             * Очистить всю историю
             */
            static clear() {
                try {
                    localStorage.removeItem(this.STORAGE_KEY);
                } catch (error) {
                    console.error('Ошибка при удалении истории:', error);
                }
            }
        }

        /**
         * ==========================================
         * КЛАСС: УПРАВЛЕНИЕ УВЕДОМЛЕНИЯМИ
         * ==========================================
         */
        class ToastManager {
            static timeout = null;

            /**
             * Показать уведомление
             * @param {string} message - Текст сообщения
             * @param {boolean} isSuccess - Успех или ошибка
             */
            static show(message, isSuccess = true) {
                if (this.timeout) {
                    clearTimeout(this.timeout);
                }

                Alpine.store('app').toast = {
                    isVisible: true,
                    message: message || 'Готово',
                    isSuccess
                };

                this.timeout = setTimeout(() => {
                    Alpine.store('app').toast.isVisible = false;
                }, 3000);
            }
        }

        /**
         * ==========================================
         * КЛАСС: УПРАВЛЕНИЕ TELEGRAM WEB APP
         * ==========================================
         */
        class TelegramManager {
            static webApp = window.Telegram?.WebApp;

            /**
             * Инициализировать Telegram Web App
             */
            static initialize() {
                if (!this.webApp) return false;

                try {
                    this.webApp.ready();
                    this.webApp.expand?.();
                    this.webApp.disableVerticalSwipes?.();
                    this.webApp.enableClosingConfirmation?.();
                    
                    this.webApp.setHeaderColor?.('secondary_bg_color');
                    this.webApp.setBackgroundColor?.('secondary_bg_color');
                    
                    return true;
                } catch (error) {
                    console.error('Ошибка инициализации Telegram:', error);
                    return false;
                }
            }

            /**
             * Получить отступы безопасной области
             * @returns {Object} Объект с top и bottom отступами
             */
            static getSafeAreaInsets() {
                if (!this.webApp) {
                    return { top: 0, bottom: 0 };
                }

                const safeArea = this.webApp.safeAreaInset || {};
                const contentSafeArea = this.webApp.contentSafeAreaInset || {};

                return {
                    top: (safeArea.top || 0) + (contentSafeArea.top || 0),
                    bottom: (safeArea.bottom || 0) + (contentSafeArea.bottom || 0)
                };
            }

            /**
             * Открыть ссылку
             * @param {string} url - URL для открытия
             */
            static openLink(url) {
                if (this.webApp?.openLink) {
                    this.webApp.openLink(url);
                } else {
                    window.open(url, '_blank');
                }
            }

            /**
             * Показать подтверждение
             * @param {string} message - Текст сообщения
             * @returns {Promise<boolean>}
             */
            static async showConfirm(message) {
                return new Promise(resolve => {
                    if (this.webApp?.showConfirm) {
                        this.webApp.showConfirm(message, resolve);
                    } else {
                        resolve(window.confirm(message));
                    }
                });
            }

            /**
             * Вибрация
             * @param {string} type - Тип: light, medium, heavy
             */
            static hapticFeedback(type = 'light') {
                try {
                    this.webApp?.HapticFeedback?.impactOccurred?.(type);
                } catch {}
            }

            /**
             * Звуковое уведомление
             * @param {string} type - Тип: success, error
             */
            static notificationFeedback(type = 'success') {
                try {
                    this.webApp?.HapticFeedback?.notificationOccurred?.(type);
                } catch {}
            }

            /**
             * Слушать события
             * @param {string} event - Событие
             * @param {Function} callback - Функция обратного вызова
             */
            static addEventListener(event, callback) {
                if (this.webApp?.onEvent) {
                    this.webApp.onEvent(event, callback);
                }
            }
        }

        /**
         * ==========================================
         * ГЛАВНЫЙ МЕНЕДЖЕР ПРИЛОЖЕНИЯ
         * ==========================================
         */
        class AppManager {
            static init() {
                return {
                    // === СОСТОЯНИЕ ===
                    url: '',
                    urlError: '',
                    activePlatform: null,
                    isLoading: false,
                    analysisError: '',
                    video: null,
                    selectedMedia: null,
                    isDownloading: false,
                    downloadProgress: 0,
                    history: HistoryManager.load(),
                    safeAreaTop: 0,
                    safeAreaBottom: 0,

                    // === ДАННЫЕ ПЛАТФОРМ ===
                    platforms: [
                        {
                            id: 'ig',
                            name: 'Instagram',
                            gradient: 'linear-gradient(45deg, #f09433, #dc2743, #bc1888)',
                            regex: /instagram\.com/i,
                            svg: '<svg fill="currentColor" viewBox="0 0 24 24"><path d="M12 2c2.717 0 3.056.01 4.122.06 1.065.05 1.79.217 2.428.465.66.254 1.216.598 1.772 1.153.509.5.902 1.105 1.153 1.772.247.637.415 1.363.465 2.428.047 1.066.06 1.405.06 4.122 0 2.717-.01 3.056-.06 4.122-.05 1.065-.218 1.79-.465 2.428a4.883 4.883 0 01-1.153 1.772c-.5.508-1.105.902-1.772 1.153-.637.247-1.363.415-2.428.465-1.066.047-1.405.06-4.122.06-2.717 0-3.056-.01-4.122-.06-1.065-.05-1.79-.218-2.428-.465a4.89 4.89 0 01-1.772-1.153 4.904 4.904 0 01-1.153-1.772c-.248-.637-.415-1.363-.465-2.428C2.013 15.056 2 14.717 2 12c0-2.717.01-3.056.06-4.122.05-1.066.217-1.79.465-2.428a4.88 4.88 0 011.153-1.772A4.897 4.897 0 015.45 2.525c.638-.248 1.362-.415 2.428-.465C8.944 2.013 9.283 2 12 2zm0 5a5 5 0 100 10 5 5 0 000-10zm6.5-.25a1.25 1.25 0 10-2.5 0 1.25 1.25 0 002.5 0zM12 9a3 3 0 110 6 3 3 0 010-6z"/></svg>'
                        },
                        {
                            id: 'tt',
                            name: 'TikTok',
                            gradient: '#000000',
                            regex: /tiktok\.com|vm\.tiktok/i,
                            svg: '<svg fill="currentColor" viewBox="0 0 24 24"><path d="M19.59 6.69a4.83 4.83 0 01-3.77-4.25V2h-3.45v13.67a2.89 2.89 0 01-5.2 1.74 2.89 2.89 0 012.31-4.64 2.93 2.93 0 01.88.13V9.4a6.84 6.84 0 00-1-.05A6.33 6.33 0 005 20.1a6.34 6.34 0 0010.86-4.43v-7a8.16 8.16 0 004.77 1.52v-3.4a4.85 4.85 0 01-1-.1z"/></svg>'
                        },
                        {
                            id: 'yt',
                            name: 'YouTube',
                            gradient: '#dc2626',
                            regex: /youtube\.com|youtu\.be/i,
                            svg: '<svg fill="currentColor" viewBox="0 0 24 24"><path d="M23.5 6.19a3.02 3.02 0 00-2.12-2.14C19.5 3.5 12 3.5 12 3.5s-7.5 0-9.38.5A3.02 3.02 0 00.5 6.19C0 8.07 0 12 0 12s0 3.93.5 5.81a3.02 3.02 0 002.12 2.14c1.88.5 9.38.5 9.38.5s7.5 0 9.38-.5a3.02 3.02 0 002.12-2.14C24 15.93 24 12 24 12s0-3.93-.5-5.81zM9.55 15.57V8.43L15.82 12l-6.27 3.57z"/></svg>'
                        },
                        {
                            id: 'x',
                            name: 'X / Twitter',
                            gradient: '#000000',
                            regex: /twitter\.com|x\.com/i,
                            svg: '<svg fill="currentColor" viewBox="0 0 24 24"><path d="M18.24 2.25h3.31l-7.23 8.26 8.5 11.24h-6.66l-5.21-6.82-5.97 6.82H1.68l7.73-8.84L1.25 2.25h6.83l4.71 6.23zm-1.16 17.52h1.83L7.08 4.13H5.12z"/></svg>'
                        }
                    ],

                    // === TOAST ===
                    toast: {
                        isVisible: false,
                        message: '',
                        isSuccess: true
                    },

                    /**
                     * Инициализация
                     */
                    initializeTelegramApp() {
                        TelegramManager.initialize();
                        
                        const insets = TelegramManager.getSafeAreaInsets();
                        this.safeAreaTop = insets.top;
                        this.safeAreaBottom = insets.bottom;

                        TelegramManager.addEventListener('viewportChanged', () => {
                            const newInsets = TelegramManager.getSafeAreaInsets();
                            this.safeAreaTop = newInsets.top;
                            this.safeAreaBottom = newInsets.bottom;
                        });
                    },

                    /**
                     * Вставить из буфера обмена
                     */
                    async pasteFromClipboard() {
                        TelegramManager.hapticFeedback('light');
                        
                        try {
                            const text = await navigator.clipboard.readText();
                            
                            if (!text) {
                                throw new Error('Буфер обмена пуст');
                            }

                            this.url = text.trim();
                            this.analyzeVideo();
                        } catch (error) {
                            ToastManager.show('Не удалось получить доступ к буферу обмена', false);
                            TelegramManager.notificationFeedback('error');
                        }
                    },

                    /**
                     * Выбрать платформу
                     */
                    selectPlatform(platformId) {
                        this.activePlatform = this.activePlatform === platformId ? null : platformId;
                        TelegramManager.hapticFeedback('light');
                    },

                    /**
                     * Анализировать видео
                     */
                    async analyzeVideo() {
                        this.urlError = '';
                        this.analysisError = '';
                        this.video = null;
                        this.selectedMedia = null;

                        const trimmedUrl = this.url.trim();

                        if (!trimmedUrl) {
                            this.activePlatform = null;
                            return;
                        }

                        if (!this.isValidUrl(trimmedUrl)) {
                            this.urlError = 'Пожалуйста, введите корректную ссылку';
                            this.activePlatform = null;
                            return;
                        }

                        const platform = this.detectPlatform(trimmedUrl);
                        this.activePlatform = platform?.id || null;

                        if (!platform) {
                            this.urlError = 'Платформа не поддерживается';
                            return;
                        }

                        this.isLoading = true;

                        try {
                            const videoData = await APIManager.fetchVideo(trimmedUrl);

                            if (!videoData.medias || videoData.medias.length === 0) {
                                throw new Error('Для этого видео нет доступных форматов');
                            }

                            this.video = {
                                id: crypto.randomUUID(),
                                title: videoData.title,
                                author: videoData.author,
                                duration: videoData.duration,
                                thumbnail: videoData.thumbnail,
                                medias: videoData.medias,
                                sourceUrl: trimmedUrl
                            };

                            const videoMedia = this.video.medias.find(m => m.type === 'video');
                            this.selectedMedia = videoMedia || this.video.medias[0];

                            TelegramManager.notificationFeedback('success');
                        } catch (error) {
                            this.analysisError = error.message || 'Не удалось получить информацию о видео';
                            TelegramManager.notificationFeedback('error');
                        } finally {
                            this.isLoading = false;
                        }
                    },

                    /**
                     * Проверить URL
                     */
                    isValidUrl(urlString) {
                        try {
                            const url = new URL(urlString);
                            return /^https?:$/.test(url.protocol);
                        } catch {
                            return false;
                        }
                    },

                    /**
                     * Определить платформу
                     */
                    detectPlatform(url) {
                        return this.platforms.find(p => p.regex.test(url)) || null;
                    },

                    /**
                     * Выбрать медиа
                     */
                    selectMedia(media) {
                        this.selectedMedia = media;
                        TelegramManager.hapticFeedback('light');
                    },

                    /**
                     * Форматировать метку медиа
                     */
                    formatMediaLabel(media) {
                        if (!media) return 'Скачать';

                        const parts = [];

                        if (media.quality) {
                            parts.push(media.quality);
                        }

                        if (media.extension) {
                            parts.push(media.extension.toUpperCase());
                        }

                        if (media.formattedSize) {
                            parts.push(media.formattedSize);
                        }

                        return parts.length > 0 
                            ? parts.join(' • ') 
                            : (media.type || 'Скачать');
                    },

                    /**
                     * Текст кнопки
                     */
                    getDownloadButtonText() {
                        if (this.isDownloading) return 'Загрузка...';
                        if (!this.video) return 'Вставьте ссылку';
                        if (!this.selectedMedia) return 'Выберите качество';
                        return 'Скачать';
                    },

                    /**
                     * Скачать видео
                     */
                    async downloadVideo() {
                        if (!this.video || !this.selectedMedia || this.isDownloading) {
                            return;
                        }

                        this.isDownloading = true;
                        this.downloadProgress = 0;
                        TelegramManager.hapticFeedback('medium');

                        try {
                            const downloadUrl = this.selectedMedia.url;

                            if (!downloadUrl) {
                                throw new Error('Ссылка на скачивание недоступна');
                            }

                            TelegramManager.openLink(downloadUrl);

                            const progressInterval = setInterval(() => {
                                const increment = Math.floor(Math.random() * 20) + 10;
                                this.downloadProgress = Math.min(95, this.downloadProgress + increment);

                                if (this.downloadProgress >= 95) {
                                    clearInterval(progressInterval);
                                }
                            }, 150);

                            await new Promise(resolve => setTimeout(resolve, 2000));
                            this.downloadProgress = 100;

                            const historyItem = {
                                id: this.video.id,
                                title: this.video.title,
                                thumbnail: this.video.thumbnail,
                                url: this.video.sourceUrl,
                                timestamp: Date.now()
                            };

                            HistoryManager.save(historyItem);
                            this.history = HistoryManager.load();

                            ToastManager.show('✓ Загрузка началась!', true);
                            TelegramManager.notificationFeedback('success');
                        } catch (error) {
                            ToastManager.show(error.message || 'Ошибка при загрузке', false);
                            TelegramManager.notificationFeedback('error');
                        } finally {
                            this.isDownloading = false;
                            
                            setTimeout(() => {
                                this.downloadProgress = 0;
                            }, 1000);
                        }
                    },

                    /**
                     * Загрузить из истории
                     */
                    async loadFromHistory(historyItem) {
                        this.url = historyItem.url;
                        await this.analyzeVideo();
                        TelegramManager.hapticFeedback('medium');
                    },

                    /**
                     * Форматировать время
                     */
                    formatTimeAgo(timestamp) {
                        const seconds = Math.floor((Date.now() - timestamp) / 1000);
                        const minutes = Math.floor(seconds / 60);
                        const hours = Math.floor(minutes / 60);
                        const days = Math.floor(hours / 24);

                        if (seconds < 60) return 'Только что';
                        if (minutes < 60) return `${minutes}м назад`;
                        if (hours < 24) return `${hours}ч назад`;
                        if (days < 30) return `${days}д назад`;
                        
                        return 'Давно';
                    },

                    /**
                     * Очистить историю
                     */
                    async clearHistory() {
                        const confirmed = await TelegramManager.showConfirm(
                            'Вы уверены, что хотите очистить всю историю?'
                        );

                        if (!confirmed) return;

                        HistoryManager.clear();
                        this.history = [];
                        ToastManager.show('История очищена', true);
                        TelegramManager.hapticFeedback('medium');
                    }
                };
            }
        }

        document.addEventListener('alpine:init', () => {
            Alpine.store('app', {
                toast: {
                    isVisible: false,
                    message: '',
                    isSuccess: true
                }
            });
        });
    </script>
</body>
</html>