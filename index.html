<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
    <meta name="color-scheme" content="light">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.14.8/dist/cdn.min.js"></script>
    <style type="text/tailwindcss">
        @theme {
            --color-bg: #ffffff;
            --color-surface: #f5f5f7;
            --color-border: #e5e5e5;
            --color-text: #1d1d1f;
            --color-muted: #86868b;
            --color-tiktok: #fe2c55;
            --color-instagram: #e4405f;
        }

        * { -webkit-tap-highlight-color: transparent }
        html, body { background: #fff; font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', system-ui, sans-serif; overscroll-behavior: none; -webkit-font-smoothing: antialiased }
        body { padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left) }
        input { font-size: 16px !important }
        input:focus { outline: none }
        .press { transition: transform 80ms, opacity 80ms }
        .press:active { transform: scale(0.97); opacity: 0.8 }
        @keyframes fade { from { opacity: 0; transform: translateY(10px) } }
        .fade { animation: fade 0.35s ease both }
        .no-scroll::-webkit-scrollbar { display: none }
        .no-scroll { scrollbar-width: none }
        .clamp { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden }
    </style>
</head>
<body x-data="App" class="min-h-dvh flex flex-col bg-bg text-text">
    <main class="flex-1 flex flex-col px-4 pb-32 max-w-md mx-auto w-full">
        
        <header class="pt-8 pb-6 text-center fade">
            <h1 class="text-3xl font-bold tracking-tight">Clipper</h1>
            <p class="text-muted text-sm mt-1.5" x-text="status"></p>
        </header>

        <section class="space-y-3 fade" style="animation-delay:40ms">
            <label class="relative block">
                <svg class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-muted pointer-events-none" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M13.19 8.688a4.5 4.5 0 0 1 1.242 7.244l-4.5 4.5a4.5 4.5 0 0 1-6.364-6.364l1.757-1.757m13.35-.622 1.757-1.757a4.5 4.5 0 0 0-6.364-6.364l-4.5 4.5a4.5 4.5 0 0 0 1.242 7.244"/></svg>
                <input x-ref="input" x-model="url" @input.debounce.80ms="detect" @paste="$nextTick(detect)" @keydown.enter.prevent="exec" :disabled="loading" type="url" inputmode="url" autocomplete="off" spellcheck="false" enterkeyhint="go" placeholder="Вставьте ссылку на видео" class="w-full h-14 pl-12 pr-12 rounded-2xl bg-surface text-text placeholder:text-muted border border-border focus:border-text/20 transition-colors disabled:opacity-40">
                <button x-show="url" x-transition.opacity @click="reset" type="button" class="absolute right-3 top-1/2 -translate-y-1/2 w-8 h-8 rounded-full bg-border grid place-items-center press">
                    <svg class="w-4 h-4 text-muted" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </label>

            <button x-show="platform&&!loading&&!result" x-transition.opacity @click="exec" type="button" class="w-full h-14 rounded-2xl bg-text text-bg font-semibold flex items-center justify-center gap-2.5 press">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3"/></svg>
                <span>Скачать видео</span>
            </button>
        </section>

        <template x-if="loading">
            <section class="flex-1 flex flex-col items-center justify-center py-16 fade">
                <div class="w-56 mb-5">
                    <div class="flex justify-between mb-2"><span class="text-sm font-semibold">Загрузка</span><span class="text-sm font-semibold" x-text="progress+'%'"></span></div>
                    <div class="h-1.5 bg-surface rounded-full overflow-hidden"><div class="h-full rounded-full transition-all duration-150" :class="platformColor" :style="{width:progress+'%'}"></div></div>
                </div>
                <p class="text-muted text-sm" x-text="progressText"></p>
            </section>
        </template>

        <template x-if="error&&!loading">
            <section class="mt-5 p-4 rounded-2xl bg-red-50 border border-red-100 fade">
                <div class="flex gap-3">
                    <div class="w-10 h-10 rounded-full bg-red-100 grid place-items-center shrink-0"><svg class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 1 1-18 0 9 9 0 0 1 18 0zm-9 3.75h.008v.008H12v-.008z"/></svg></div>
                    <div class="pt-0.5"><p class="font-semibold text-red-600 text-sm">Ошибка</p><p class="text-sm text-red-500 mt-0.5" x-text="error"></p></div>
                </div>
            </section>
        </template>

        <template x-if="result&&!loading">
            <section class="mt-5 space-y-3 fade">
                <div class="rounded-2xl overflow-hidden bg-black">
                    <div class="relative w-full" style="aspect-ratio:9/16;max-height:60dvh">
                        <video :src="result.video" :poster="result.cover" class="absolute inset-0 w-full h-full object-cover" controls playsinline></video>
                        <div class="absolute top-3 left-3 flex items-center gap-1.5 px-2.5 py-1.5 rounded-lg bg-white/95 shadow-sm">
                            <svg class="w-4 h-4" :class="platformColor" x-html="platformIcon"></svg>
                            <span class="text-xs font-semibold" x-text="platformName"></span>
                        </div>
                        <div class="absolute top-3 right-3 px-2.5 py-1.5 rounded-lg bg-white/95 shadow-sm"><span class="text-xs font-semibold" x-text="fmt.time(result.duration)"></span></div>
                    </div>
                </div>

                <div class="flex items-center gap-3 p-3.5 rounded-2xl bg-surface border border-border">
                    <img :src="result.author.avatar" class="w-11 h-11 rounded-full object-cover border border-border">
                    <div class="flex-1 min-w-0"><p class="font-semibold truncate" x-text="result.author.name"></p><p class="text-sm text-muted truncate" x-text="'@'+result.author.username"></p></div>
                    <svg class="w-5 h-5 shrink-0" :class="platformColor" x-html="platformIcon"></svg>
                </div>

                <p x-show="result.title" class="text-sm clamp leading-relaxed" x-text="result.title"></p>

                <div class="grid grid-cols-4 gap-1 p-2.5 rounded-2xl bg-surface border border-border">
                    <template x-for="s in stats"><div class="text-center py-1.5">
                        <div class="w-8 h-8 mx-auto mb-1.5 rounded-full grid place-items-center" :class="platformColor+'/10'"><svg class="w-4 h-4" :class="platformColor" x-html="s.icon"></svg></div>
                        <p class="text-sm font-semibold" x-text="fmt.num(result[s.key])"></p><p class="text-[10px] text-muted mt-0.5" x-text="s.label"></p>
                    </div></template>
                </div>

                <div class="grid grid-cols-2 gap-2.5 pt-1">
                    <button @click="save" type="button" class="h-14 rounded-2xl bg-text text-bg font-semibold flex items-center justify-center gap-2 press">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3"/></svg>
                        <span>Сохранить</span>
                    </button>
                    <button @click="story" type="button" class="h-14 rounded-2xl text-white font-semibold flex items-center justify-center gap-2 press" :class="platformColor">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v6m3-3H9m12 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"/></svg>
                        <span>В историю</span>
                    </button>
                </div>
            </section>
        </template>

        <template x-if="history.length&&!loading">
            <section class="mt-7 fade" style="animation-delay:80ms">
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center gap-2"><svg class="w-5 h-5 text-muted" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"/></svg><h2 class="font-semibold">Недавние</h2></div>
                    <button @click="clearHistory" type="button" class="text-sm text-muted press">Очистить</button>
                </div>
                <div class="flex gap-2.5 overflow-x-auto -mx-4 px-4 pb-2 no-scroll">
                    <template x-for="h in history" :key="h.id"><button @click="fromHistory(h)" type="button" class="shrink-0 w-20 press">
                        <div class="relative w-20 h-28 rounded-xl overflow-hidden border border-border mb-1.5">
                            <img :src="h.cover" class="w-full h-full object-cover" loading="lazy">
                            <div class="absolute inset-x-0 bottom-0 h-10 bg-gradient-to-t from-black/60 to-transparent"></div>
                            <div class="absolute bottom-1.5 left-1.5 w-5 h-5 rounded-full bg-white grid place-items-center"><svg class="w-3 h-3" :class="'text-'+h.platform" x-html="platforms[h.platform]?.icon"></svg></div>
                        </div>
                        <p class="text-[11px] text-muted truncate text-left" x-text="h.author"></p>
                    </button></template>
                </div>
            </section>
        </template>

        <footer class="mt-auto pt-10 fade" style="animation-delay:100ms" x-show="!loading&&!result">
            <p class="text-center text-xs text-muted mb-3">Поддерживаемые платформы</p>
            <div class="flex justify-center gap-2.5">
                <template x-for="(p,k) in platforms" :key="k">
                    <div class="flex items-center gap-2 px-4 py-2.5 rounded-xl bg-surface border border-border" :class="{'opacity-50':!p.active}">
                        <svg class="w-5 h-5" :class="p.active?'text-'+k:'text-muted'" x-html="p.icon"></svg>
                        <span class="text-sm font-semibold" :class="p.active?'text-text':'text-muted'" x-text="p.name"></span>
                        <span x-show="!p.active" class="text-[10px] text-muted bg-border px-1.5 py-0.5 rounded">скоро</span>
                    </div>
                </template>
            </div>
        </footer>
    </main>

    <script>
    class TelegramBridge {
        static #instance = window.Telegram?.WebApp;

        static init() {
            this.#instance?.ready();
            this.#instance?.expand();
            this.#instance?.setHeaderColor('#ffffff');
            this.#instance?.setBackgroundColor('#ffffff');
        }

        static haptic(style = 'light') {
            this.#instance?.HapticFeedback?.impactOccurred(style);
        }

        static notify(type) {
            this.#instance?.HapticFeedback?.notificationOccurred(type);
        }

        static download(url, name) {
            return this.#instance?.downloadFile?.({ url, file_name: name }) ?? false;
        }

        static shareStory(url) {
            return this.#instance?.shareToStory?.(url, { widget_link: { url: 'https://t.me/clipper_bot', name: 'Clipper' } }) ?? false;
        }
    }

    class Platform {
        static id = '';
        static name = '';
        static color = '';
        static icon = '';
        static patterns = [];
        static endpoint = '';

        static test(url) {
            return this.patterns.some(p => p.test(url));
        }

        static async fetch(url) {
            throw new Error('Not implemented');
        }

        static normalize(data) {
            throw new Error('Not implemented');
        }
    }

    class TikTok extends Platform {
        static id = 'tiktok';
        static name = 'TikTok';
        static color = 'bg-tiktok';
        static icon = '<path d="M19.59 6.69a4.83 4.83 0 0 1-3.77-4.25V2h-3.45v13.67a2.89 2.89 0 0 1-5.2 1.74 2.89 2.89 0 0 1 2.31-4.64c.29 0 .58.04.88.13V9.4c-.29-.03-.6-.05-1-.05A6.33 6.33 0 0 0 5 20.1a6.34 6.34 0 0 0 10.86-4.43v-7a8.16 8.16 0 0 0 4.77 1.52v-3.4c-.35-.05-.7-.08-1.04-.1z"/>';
        static patterns = [/tiktok\.com\/@[\w.-]+\/video\/\d+/i, /tiktok\.com\/t\/[\w-]+/i, /vm\.tiktok\.com\/[\w-]+/i, /vt\.tiktok\.com\/[\w-]+/i];
        static endpoint = 'https://www.tikwm.com/api/';

        static async fetch(url) {
            const res = await fetch(this.endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: new URLSearchParams({ url, hd: 1 })
            });

            if (!res.ok) throw new Error('Ошибка сети');

            const { code, msg, data } = await res.json();
            if (code !== 0) throw new Error(msg || 'Видео не найдено');

            return this.normalize(data);
        }

        static normalize(d) {
            return {
                id: d.id,
                video: d.play,
                cover: d.cover,
                title: d.title,
                duration: d.duration,
                plays: d.play_count,
                likes: d.digg_count,
                comments: d.comment_count,
                shares: d.share_count,
                author: { name: d.author.nickname, username: d.author.unique_id, avatar: d.author.avatar }
            };
        }
    }

    class Instagram extends Platform {
        static id = 'instagram';
        static name = 'Instagram';
        static color = 'bg-instagram';
        static icon = '<path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zM12 0C8.741 0 8.333.014 7.053.072 2.695.272.273 2.69.073 7.052.014 8.333 0 8.741 0 12c0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98C8.333 23.986 8.741 24 12 24c3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98C15.668.014 15.259 0 12 0zm0 5.838a6.162 6.162 0 1 0 0 12.324 6.162 6.162 0 0 0 0-12.324zM12 16a4 4 0 1 1 0-8 4 4 0 0 1 0 8zm6.406-11.845a1.44 1.44 0 1 0 0 2.881 1.44 1.44 0 0 0 0-2.881z"/>';
        static patterns = [/instagram\.com\/(?:p|reel|reels)\/[\w-]+/i, /instagr\.am\/[\w-]+/i];
        static active = false;
    }

    class PlatformRegistry {
        static #platforms = new Map();

        static register(platform) {
            this.#platforms.set(platform.id, platform);
        }

        static detect(url) {
            for (const [id, platform] of this.#platforms) {
                if (platform.test(url)) return id;
            }
            return null;
        }

        static get(id) {
            return this.#platforms.get(id);
        }

        static all() {
            return Object.fromEntries([...this.#platforms].map(([k, v]) => [k, { name: v.name, icon: v.icon, active: v.active !== false }]));
        }
    }

    class HistoryManager {
        static #key = 'clipper_v1';
        static #max = 20;

        static get() {
            try { return JSON.parse(localStorage.getItem(this.#key)) ?? []; }
            catch { return []; }
        }

        static add(item) {
            const list = this.get().filter(i => i.id !== item.id);
            list.unshift(item);
            try { localStorage.setItem(this.#key, JSON.stringify(list.slice(0, this.#max))); }
            catch { }
        }

        static clear() {
            try { localStorage.removeItem(this.#key); }
            catch { }
        }
    }

    const Formatter = {
        num: n => n >= 1e6 ? (n / 1e6).toFixed(1) + 'M' : n >= 1e3 ? (n / 1e3).toFixed(1) + 'K' : String(n ?? 0),
        time: s => `${Math.floor(s / 60)}:${String(Math.floor(s % 60)).padStart(2, '0')}`
    };

    const Icons = {
        play: '<path stroke-linecap="round" stroke-linejoin="round" d="M5.25 5.653c0-.856.917-1.398 1.667-.986l11.54 6.347a1.125 1.125 0 0 1 0 1.972l-11.54 6.347a1.125 1.125 0 0 1-1.667-.986V5.653Z"/>',
        heart: '<path stroke-linecap="round" stroke-linejoin="round" d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12Z"/>',
        comment: '<path stroke-linecap="round" stroke-linejoin="round" d="M12 20.25c4.97 0 9-3.694 9-8.25s-4.03-8.25-9-8.25S3 7.444 3 12c0 2.104.859 4.023 2.273 5.48.432.447.74 1.04.586 1.641a4.483 4.483 0 0 1-.923 1.785A5.969 5.969 0 0 0 6 21c1.282 0 2.47-.402 3.445-1.087.81.22 1.668.337 2.555.337Z"/>',
        share: '<path stroke-linecap="round" stroke-linejoin="round" d="M7.217 10.907a2.25 2.25 0 1 0 0 2.186m0-2.186c.18.324.283.696.283 1.093s-.103.77-.283 1.093m0-2.186 9.566-5.314m-9.566 7.5 9.566 5.314m0 0a2.25 2.25 0 1 0 3.935 2.186 2.25 2.25 0 0 0-3.935-2.186Zm0-12.814a2.25 2.25 0 1 0 3.933-2.185 2.25 2.25 0 0 0-3.933 2.185Z"/>'
    };

    PlatformRegistry.register(TikTok);
    PlatformRegistry.register(Instagram);

    document.addEventListener('alpine:init', () => {
        Alpine.data('App', () => ({
            url: '',
            platform: null,
            loading: false,
            progress: 0,
            result: null,
            error: null,
            history: HistoryManager.get(),
            platforms: PlatformRegistry.all(),
            fmt: Formatter,

            stats: [
                { key: 'plays', label: 'Просмотры', icon: Icons.play },
                { key: 'likes', label: 'Лайки', icon: Icons.heart },
                { key: 'comments', label: 'Комменты', icon: Icons.comment },
                { key: 'shares', label: 'Репосты', icon: Icons.share }
            ],

            get status() {
                if (this.loading) return 'Загрузка видео...';
                if (this.error) return 'Попробуйте другую ссылку';
                if (this.result) return 'Видео готово';
                if (this.platform) return `${this.platformName} видео найдено`;
                return 'Скачивайте без водяных знаков';
            },

            get progressText() {
                if (this.progress < 30) return 'Подключение...';
                if (this.progress < 70) return 'Получение видео...';
                return 'Почти готово...';
            },

            get platformName() {
                return PlatformRegistry.get(this.platform)?.name ?? '';
            },

            get platformColor() {
                return PlatformRegistry.get(this.platform)?.color ?? 'bg-text';
            },

            get platformIcon() {
                return PlatformRegistry.get(this.platform)?.icon ?? '';
            },

            init() {
                TelegramBridge.init();
            },

            detect() {
                this.error = null;
                const detected = PlatformRegistry.detect(this.url);
                const p = PlatformRegistry.get(detected);
                this.platform = p?.active !== false ? detected : null;
                if (this.platform) TelegramBridge.haptic('light');
            },

            reset() {
                Object.assign(this, { url: '', platform: null, result: null, error: null });
                TelegramBridge.haptic('light');
            },

            blur() {
                this.$refs.input?.blur();
            },

            async exec() {
                if (!this.platform || this.loading) return;

                this.blur();
                Object.assign(this, { loading: true, progress: 0, error: null, result: null });
                TelegramBridge.haptic('medium');

                const tick = setInterval(() => {
                    this.progress = Math.min(this.progress + ~~(Math.random() * 8) + 3, 95);
                }, 120);

                try {
                    const p = PlatformRegistry.get(this.platform);
                    this.result = await p.fetch(this.url);
                    this.progress = 100;

                    HistoryManager.add({
                        id: this.result.id,
                        platform: this.platform,
                        cover: this.result.cover,
                        author: this.result.author.name,
                        url: this.url
                    });

                    this.history = HistoryManager.get();
                    TelegramBridge.notify('success');
                } catch (e) {
                    this.error = e?.message ?? 'Произошла ошибка';
                    TelegramBridge.notify('error');
                } finally {
                    clearInterval(tick);
                    this.loading = false;
                }
            },

            save() {
                if (!this.result?.video) return;

                const name = `${this.platform}_${this.result.id}.mp4`;
                
                if (!TelegramBridge.download(this.result.video, name)) {
                    Object.assign(document.createElement('a'), {
                        href: this.result.video,
                        download: name,
                        target: '_blank',
                        rel: 'noopener'
                    }).click();
                }

                TelegramBridge.notify('success');
            },

            story() {
                if (!this.result?.video) return;

                if (!TelegramBridge.shareStory(this.result.video)) {
                    this.error = 'Истории доступны в мобильном Telegram';
                    TelegramBridge.notify('error');
                    return;
                }

                TelegramBridge.notify('success');
            },

            fromHistory(h) {
                Object.assign(this, { url: h.url, result: null, error: null });
                this.detect();
                TelegramBridge.haptic('light');
            },

            clearHistory() {
                HistoryManager.clear();
                this.history = [];
                TelegramBridge.haptic('medium');
            }
        }));
    });
    </script>
</body>
</html>