<!DOCTYPE html>
<html lang="ru" class="h-full">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width,initial-scale=1,viewport-fit=cover"
    />
    <meta name="color-scheme" content="light" />
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/alpinejs@3.14.8/dist/cdn.min.js"
    ></script>
    <script
      async
      src="https://plausible.io/js/pa-QR-RoZMy12hrhzIXv4u0Z.js"
    ></script>
    <script>
      window.plausible =
        window.plausible ||
        function () {
          (plausible.q = plausible.q || []).push(arguments);
        };
      plausible.init =
        plausible.init ||
        function (i) {
          plausible.o = i || {};
        };
      plausible.init();
    </script>
    <style type="text/tailwindcss">
      @theme {
        --color-bg: #ffffff;
        --color-surface: #f8f8f8;
        --color-border: #ebebeb;
        --color-text: #000000;
        --color-muted: #8e8e93;
        --color-error: #ff3b30;
        --color-error-bg: #fff5f5;
        --color-error-border: #ffe5e5;
      }

      * {
        -webkit-tap-highlight-color: transparent;
        -webkit-touch-callout: none;
      }

      [x-cloak] {
        display: none !important;
      }

      html,
      body {
        background: var(--color-bg);
        font-family:
          -apple-system,
          BlinkMacSystemFont,
          "SF Pro Text",
          system-ui,
          sans-serif;
        overscroll-behavior: none;
        -webkit-font-smoothing: antialiased;
        text-rendering: optimizeLegibility;
      }

      body {
        padding: env(safe-area-inset-top) env(safe-area-inset-right)
          env(safe-area-inset-bottom) env(safe-area-inset-left);
      }

      ::-webkit-scrollbar {
        display: none;
      }

      input {
        font-size: 1rem;
        caret-color: var(--color-text);
      }

      input:focus {
        outline: none;
      }

      .press {
        @apply transition-all duration-75 ease-out active:scale-[0.97] active:opacity-80;
      }

      @keyframes fade-up {
        from {
          opacity: 0;
          transform: translateY(0.75rem);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .fade {
        animation: fade-up 0.4s cubic-bezier(0.22, 1, 0.36, 1) both;
      }
    </style>
  </head>
  <body
    x-cloak
    x-data="app"
    x-init="init()"
    class="flex min-h-dvh flex-col select-none overflow-x-hidden bg-bg text-text scrollbar-none"
  >
    <main
      class="mx-auto flex w-full max-w-md flex-1 flex-col overflow-y-auto px-5 pb-32"
    >
      <header class="fade pb-8 pt-10 text-center">
        <h1 class="text-3xl font-bold tracking-tight">Clipper</h1>
        <p class="mt-2 text-sm text-muted" x-text="statusText"></p>
      </header>

      <section class="fade space-y-3" style="animation-delay: 50ms">
        <div class="relative">
          <div
            class="pointer-events-none absolute inset-y-0 left-4 flex items-center"
          >
            <i data-lucide="link" class="size-5 text-muted"></i>
          </div>
          <input
            type="url"
            inputmode="url"
            enterkeyhint="go"
            x-ref="input"
            x-model="url"
            @input.debounce.150ms="detect"
            @paste="$nextTick(() => detect())"
            @keydown.enter.prevent="download"
            :disabled="loading"
            placeholder="Вставьте ссылку на видео"
            autocomplete="off"
            autocorrect="off"
            autocapitalize="off"
            spellcheck="false"
            class="h-14 w-full rounded-2xl border border-border bg-surface pl-12 pr-12 text-text transition-colors duration-150 placeholder:text-muted focus:border-text/20 disabled:opacity-40"
          />
          <button
            x-show="url.length"
            x-transition:enter="transition ease-out duration-100"
            x-transition:enter-start="opacity-0 scale-90"
            x-transition:enter-end="opacity-100 scale-100"
            x-transition:leave="transition ease-in duration-75"
            x-transition:leave-start="opacity-100 scale-100"
            x-transition:leave-end="opacity-0 scale-90"
            @click="clear"
            :disabled="loading"
            type="button"
            aria-label="Очистить"
            class="press absolute inset-y-0 right-3 my-auto grid size-8 place-items-center rounded-full bg-border disabled:opacity-40"
          >
            <i data-lucide="x" class="size-4 text-muted"></i>
          </button>
        </div>

        <button
          x-show="platform && !loading && !video"
          x-transition:enter="transition ease-out duration-150"
          x-transition:enter-start="opacity-0 translate-y-2"
          x-transition:enter-end="opacity-100 translate-y-0"
          x-transition:leave="transition ease-in duration-100"
          x-transition:leave-start="opacity-100"
          x-transition:leave-end="opacity-0"
          @click="download"
          :disabled="loading"
          :style="{ backgroundColor: platform?.colors?.primary }"
          type="button"
          class="press flex h-14 w-full items-center justify-center gap-2.5 rounded-2xl font-semibold text-white disabled:opacity-40"
        >
          <i data-lucide="download" class="size-5"></i>
          <span>Сохранить видео</span>
        </button>
      </section>

      <template x-if="loading">
        <section
          class="fade flex flex-1 flex-col items-center justify-center py-20"
        >
          <div class="mb-6 w-full max-w-60">
            <div class="mb-3 flex items-center justify-between">
              <span class="text-sm font-semibold text-text">Загрузка</span>
              <span
                class="text-sm font-semibold tabular-nums text-text"
                x-text="`${progress}%`"
              ></span>
            </div>
            <div
              class="h-2 overflow-hidden rounded-full border border-border bg-surface"
            >
              <div
                class="h-full rounded-full transition-[width] duration-200 ease-out"
                :style="{ backgroundColor: activePlatform?.colors?.progress, width: `${progress}%` }"
              ></div>
            </div>
          </div>
          <p class="text-sm text-muted" x-text="loadingText"></p>
        </section>
      </template>

      <template x-if="error && !loading">
        <section
          class="fade mt-6 rounded-2xl border border-error-border bg-error-bg p-4"
        >
          <div class="flex items-start gap-3">
            <div
              class="grid size-10 shrink-0 place-items-center rounded-full bg-error/10"
            >
              <i data-lucide="alert-circle" class="size-5 text-error"></i>
            </div>
            <div class="min-w-0 flex-1 pt-0.5">
              <p class="text-sm font-semibold text-error">Ошибка</p>
              <p class="mt-0.5 text-sm text-error/80" x-text="error"></p>
            </div>
          </div>
        </section>
      </template>

      <template x-if="video && !loading">
        <section class="fade mt-6 space-y-4" x-init="$nextTick(() => Icons.refresh())">
          <div
            class="overflow-hidden rounded-2xl border border-border bg-surface"
          >
            <div class="relative aspect-[9/16] w-full bg-black">
              <video
                :src="video.play"
                :poster="video.cover"
                class="absolute inset-0 size-full object-contain"
                controls
                playsinline
                disablepictureinpicture
                controlslist="nodownload noplaybackrate"
              ></video>
              <div
                class="absolute left-3 top-3 flex items-center gap-1.5 rounded-lg bg-white/95 px-2.5 py-1.5 shadow-sm backdrop-blur-sm"
              >
                <svg
                  class="size-4"
                  :style="{ color: activePlatform?.colors?.icon }"
                  viewBox="0 0 24 24"
                  fill="currentColor"
                  aria-hidden="true"
                >
                  <path :d="activePlatform?.icon" />
                </svg>
                <span
                  class="text-xs font-semibold leading-none text-text"
                  x-text="activePlatform?.name"
                ></span>
              </div>
              <div
                x-show="video.duration"
                class="absolute right-3 top-3 flex h-7 items-center justify-center rounded-lg bg-white/95 px-2.5 shadow-sm backdrop-blur-sm"
              >
                <span
                  class="text-xs font-semibold leading-none tabular-nums text-text"
                  x-text="Formatter.time(video.duration)"
                ></span>
              </div>
            </div>
          </div>

          <div
            class="flex items-center gap-3 rounded-2xl border border-border bg-surface p-4"
          >
            <img
              :src="video.author?.avatar || FALLBACK.AVATAR"
              :alt="video.author?.nickname || 'Автор'"
              @error="$el.src = FALLBACK.AVATAR"
              referrerpolicy="no-referrer"
              class="size-12 rounded-full border border-border object-cover"
              loading="lazy"
              decoding="async"
            />
            <div class="min-w-0 flex-1">
              <p
                class="truncate font-semibold text-text"
                x-text="video.author?.nickname || 'Неизвестный автор'"
              ></p>
              <p
                x-show="video.author?.unique_id"
                class="truncate text-sm text-muted"
                x-text="`@${video.author?.unique_id}`"
              ></p>
            </div>
            <svg
              class="size-5 shrink-0"
              :style="{ color: activePlatform?.colors?.icon }"
              viewBox="0 0 24 24"
              fill="currentColor"
              aria-hidden="true"
            >
              <path :d="activePlatform?.icon" />
            </svg>
          </div>

          <p
            x-show="video.title"
            x-transition
            class="line-clamp-2 px-1 text-sm leading-relaxed text-text"
            x-text="video.title"
          ></p>

          <template x-if="computedStats.length">
            <div
              class="grid gap-2 rounded-2xl border border-border bg-surface p-3"
              :class="`grid-cols-${computedStats.length}`"
            >
              <template x-for="stat in computedStats" :key="stat.key">
                <div class="flex flex-col items-center gap-1 py-2">
                  <div
                    class="grid size-9 place-items-center rounded-full"
                    :style="{ backgroundColor: activePlatform?.colors?.statsBg }"
                  >
                    <i
                      :data-lucide="stat.icon"
                      class="size-4"
                      :style="{ color: activePlatform?.colors?.statsIcon }"
                    ></i>
                  </div>
                  <p
                    class="text-sm font-semibold tabular-nums text-text"
                    x-text="Formatter.number(video[stat.key])"
                  ></p>
                  <p class="text-[10px] text-muted" x-text="stat.label"></p>
                </div>
              </template>
            </div>
          </template>

          <div class="grid grid-cols-2 gap-3 pt-2">
            <button
              @click="saveVideo"
              :style="{ backgroundColor: activePlatform?.colors?.save }"
              type="button"
              aria-label="Сохранить видео"
              class="press flex h-14 items-center justify-center gap-2 rounded-2xl font-semibold text-white"
            >
              <i data-lucide="download" class="size-5"></i>
              <span>Сохранить</span>
            </button>
            <button
              @click="shareStory"
              :style="{ backgroundColor: activePlatform?.colors?.story }"
              type="button"
              aria-label="Поделиться в историю"
              class="press flex h-14 items-center justify-center gap-2 rounded-2xl font-semibold text-white"
            >
              <i data-lucide="plus-circle" class="size-5"></i>
              <span>В историю</span>
            </button>
          </div>
        </section>
      </template>

      <template x-if="history.length && !loading">
        <section class="fade mt-8" style="animation-delay: 100ms">
          <div class="mb-4 flex items-center justify-between">
            <div class="flex items-center gap-2">
              <i data-lucide="clock" class="size-5 text-muted"></i>
              <h2 class="font-semibold text-text">Недавние видео</h2>
            </div>
            <button
              @click="clearHistory"
              type="button"
              aria-label="Очистить историю"
              class="press text-sm text-muted"
            >
              Очистить
            </button>
          </div>
          <div
            class="-mx-5 flex gap-3 overflow-x-auto px-5 pb-2 scrollbar-none"
          >
            <template x-for="item in history" :key="item.id">
              <button
                @click="loadFromHistory(item)"
                type="button"
                aria-label="Загрузить видео"
                class="press w-22 shrink-0"
              >
                <div
                  class="relative mb-2 aspect-[88/120] w-22 overflow-hidden rounded-xl border border-border"
                >
                  <img
                    :src="item.cover || FALLBACK.COVER"
                    alt=""
                    @error="$el.src = FALLBACK.COVER"
                    referrerpolicy="no-referrer"
                    class="size-full object-cover"
                    loading="lazy"
                    decoding="async"
                  />
                  <div
                    class="absolute inset-x-0 bottom-0 h-12 bg-gradient-to-t from-black/60 to-transparent"
                  ></div>
                  <div
                    class="absolute bottom-2 left-2 grid size-5 place-items-center rounded-full bg-white"
                  >
                    <svg
                      class="size-3"
                      :style="{ color: PlatformRegistry.get(item.platform)?.colors?.icon }"
                      viewBox="0 0 24 24"
                      fill="currentColor"
                      aria-hidden="true"
                    >
                      <path :d="PlatformRegistry.get(item.platform)?.icon" />
                    </svg>
                  </div>
                </div>
                <p
                  class="truncate text-left text-xs text-muted"
                  x-text="item.author"
                ></p>
              </button>
            </template>
          </div>
        </section>
      </template>

      <footer
        x-show="!loading && !video"
        x-transition
        class="fade mt-auto pt-12"
        style="animation-delay: 150ms"
      >
        <p class="mb-4 text-center text-sm text-muted">
          Поддерживаемые платформы
        </p>
        <div class="flex flex-wrap justify-center gap-3">
          <template x-for="p in PlatformRegistry.all()" :key="p.name">
            <div
              class="flex items-center gap-2.5 rounded-xl border border-border bg-surface px-5 py-3"
            >
              <svg
                class="size-5"
                :style="{ color: p.colors?.icon }"
                viewBox="0 0 24 24"
                fill="currentColor"
                aria-hidden="true"
              >
                <path :d="p.icon" />
              </svg>
              <span
                class="text-sm font-semibold text-text"
                x-text="p.name"
              ></span>
            </div>
          </template>
        </div>
      </footer>
    </main>

    <script>
      const FALLBACK = Object.freeze({
        AVATAR:
          "data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 48 48%22><rect fill=%22%23e5e5e5%22 width=%2248%22 height=%2248%22/></svg>",
        COVER:
          "data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 88 120%22><rect fill=%22%23e5e5e5%22 width=%2288%22 height=%22120%22/></svg>",
      });

      class Icons {
        static refresh() {
          lucide?.createIcons?.();
        }
      }

      class TelegramApp {
        static #instance = window.Telegram?.WebApp;

        static init() {
          const app = this.#instance;
          if (!app) return;
          app.ready();
          app.expand();
          app.requestFullscreen?.();
          app.disableVerticalSwipes?.();
          app.setHeaderColor?.("#ffffff");
          app.setBackgroundColor?.("#ffffff");
        }

        static haptic(type = "light") {
          this.#instance?.HapticFeedback?.impactOccurred?.(type);
        }

        static notify(type) {
          this.#instance?.HapticFeedback?.notificationOccurred?.(type);
        }

        static download(url, filename) {
          const app = this.#instance;
          if (!app?.downloadFile) return false;
          app.downloadFile({ url, file_name: filename });
          return true;
        }

        static shareStory(url, text) {
          const app = this.#instance;
          if (!app?.shareToStory) return false;
          app.shareToStory(url, {
            text,
            widget_link: { url: "https://t.me/ClipperAppBot", name: "Clipper" },
          });
          return true;
        }
      }

      class Storage {
        static #KEY = "clipper_history";
        static #MAX = 20;

        static get() {
          try {
            return JSON.parse(localStorage.getItem(this.#KEY)) ?? [];
          } catch {
            return [];
          }
        }

        static add(item) {
          try {
            const list = this.get().filter((i) => i.id !== item.id);
            list.unshift(item);
            localStorage.setItem(this.#KEY, JSON.stringify(list.slice(0, this.#MAX)));
          } catch {}
        }

        static clear() {
          try {
            localStorage.removeItem(this.#KEY);
          } catch {}
        }
      }

      class Formatter {
        static time(seconds) {
          if (!seconds) return "0:00";
          const m = Math.floor(seconds / 60);
          const s = Math.floor(seconds % 60);
          return `${m}:${s.toString().padStart(2, "0")}`;
        }

        static number(n) {
          if (!n) return "0";
          if (n >= 1e6) return `${(n / 1e6).toFixed(1)}M`;
          if (n >= 1e3) return `${(n / 1e3).toFixed(1)}K`;
          return String(n);
        }
      }

      class Platform {
        constructor({ name, colors, icon, patterns, stats, fetcher }) {
          this.name = name;
          this.colors = colors;
          this.icon = icon;
          this.patterns = patterns;
          this.stats = stats;
          this.fetcher = fetcher;
        }

        matches(url) {
          return this.patterns.some((p) => p.test(url));
        }

        async fetch(url, signal) {
          const data = await this.fetcher(url, signal);
          if (!data?.play) throw new Error("Видео недоступно");
          return data;
        }

        filename(id) {
          return `${this.name.toLowerCase()}_${id ?? Date.now()}.mp4`;
        }
      }

      class PlatformRegistry {
        static #list = [];

        static register(config) {
          this.#list.push(new Platform(config));
        }

        static detect(url) {
          return this.#list.find((p) => p.matches(url)) ?? null;
        }

        static get(name) {
          return this.#list.find((p) => p.name === name) ?? null;
        }

        static all() {
          return this.#list;
        }
      }

      PlatformRegistry.register({
        name: "TikTok",
        colors: {
          primary: "#fe2c55",
          progress: "#000000",
          icon: "#000000",
          save: "#fe2c55",
          story: "#000000",
          statsBg: "#fe2c5520",
          statsIcon: "#fe2c55",
        },
        icon: "M19.59 6.69a4.83 4.83 0 0 1-3.77-4.25V2h-3.45v13.67a2.89 2.89 0 0 1-5.2 1.74 2.89 2.89 0 0 1 2.31-4.64c.29 0 .58.04.88.13V9.4a7 7 0 0 0-1-.05A6.33 6.33 0 0 0 5 20.1a6.34 6.34 0 0 0 10.86-4.43v-7a8.16 8.16 0 0 0 4.77 1.52v-3.4a5 5 0 0 1-1.04-.1Z",
        patterns: [
          /tiktok\.com\/@[\w.-]+\/video\/\d+/i,
          /tiktok\.com\/t\/[\w-]+/i,
          /vm\.tiktok\.com\/[\w-]+/i,
          /vt\.tiktok\.com\/[\w-]+/i,
        ],
        stats: [
          { key: "play_count", label: "Просмотры", icon: "play" },
          { key: "digg_count", label: "Лайки", icon: "heart" },
          { key: "comment_count", label: "Комменты", icon: "message-circle" },
          { key: "share_count", label: "Репосты", icon: "share-2" },
        ],
        fetcher: async (url, signal) => {
          const res = await fetch("https://www.tikwm.com/api/", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: new URLSearchParams({ url, hd: 1 }),
            signal,
          });
          if (!res.ok) throw new Error("Ошибка сети");
          const json = await res.json();
          if (json.code !== 0) throw new Error("Видео не найдено");
          return json.data;
        },
      });

      window.FALLBACK = FALLBACK;
      window.Icons = Icons;
      window.Formatter = Formatter;
      window.PlatformRegistry = PlatformRegistry;

      document.addEventListener("alpine:init", () => {
        Alpine.data("app", () => ({
          url: "",
          platform: null,
          activePlatform: null,
          loading: false,
          progress: 0,
          video: null,
          error: null,
          history: [],
          progressTimer: null,

          get statusText() {
            if (this.loading) return "Загрузка видео...";
            if (this.error) return "Попробуйте другую ссылку";
            if (this.video) return "Видео готово к сохранению";
            if (this.platform) return `${this.platform.name} видео найдено`;
            return "Сохраняйте видео легко и быстро";
          },

          get loadingText() {
            if (this.progress < 30) return "Подключение к серверу...";
            if (this.progress < 60) return "Получение видео...";
            if (this.progress < 90) return "Обработка данных...";
            return "Почти готово...";
          },

          get computedStats() {
            if (!this.activePlatform?.stats || !this.video) return [];
            return this.activePlatform.stats.filter(
              (s) => this.video[s.key] != null && this.video[s.key] > 0
            );
          },

          init() {
            TelegramApp.init();
            this.history = Storage.get();
            this.$nextTick(() => Icons.refresh());
          },

          detect() {
            this.error = null;
            const detected = PlatformRegistry.detect(this.url);
            if (detected) {
              this.platform = detected;
              TelegramApp.haptic("light");
            } else if (!this.video) {
              this.platform = null;
            }
          },

          clear() {
            this.url = "";
            this.platform = null;
            this.activePlatform = null;
            this.video = null;
            this.error = null;
            TelegramApp.haptic("light");
          },

          stopProgress() {
            if (this.progressTimer) {
              clearInterval(this.progressTimer);
              this.progressTimer = null;
            }
          },

          async download() {
            if (!this.platform || this.loading) return;
            this.$refs.input?.blur();
            this.loading = true;
            this.progress = 0;
            this.error = null;
            this.video = null;
            this.activePlatform = this.platform;
            TelegramApp.haptic("medium");

            this.stopProgress();
            this.progressTimer = setInterval(() => {
              this.progress = Math.min(
                this.progress + Math.floor(Math.random() * 8) + 2,
                95
              );
            }, 100);

            const controller = new AbortController();
            const timeout = setTimeout(() => controller.abort(), 15000);

            try {
              const data = await this.activePlatform.fetch(
                this.url,
                controller.signal
              );
              this.video = data;
              this.progress = 100;
              Storage.add({
                id: data.id ?? Date.now(),
                cover: data.cover,
                author:
                  data.author?.nickname ?? data.author?.unique_id ?? "Автор",
                url: this.url,
                platform: this.activePlatform.name,
              });
              this.history = Storage.get();
              TelegramApp.notify("success");
            } catch (e) {
              this.error =
                e.name === "AbortError"
                  ? "Превышено время ожидания"
                  : e.message ?? "Ошибка";
              TelegramApp.notify("error");
            } finally {
              clearTimeout(timeout);
              this.stopProgress();
              this.loading = false;
            }
          },

          saveVideo() {
            if (!this.video?.play) return;
            const filename = this.activePlatform.filename(this.video.id);
            const ok = TelegramApp.download(this.video.play, filename);
            if (ok) {
              TelegramApp.notify("success");
            } else {
              this.error = "Скачивание доступно только в мобильном Telegram";
              TelegramApp.notify("error");
            }
          },

          shareStory() {
            if (!this.video?.play) return;
            const text = this.video.title?.trim() ?? "";
            const ok = TelegramApp.shareStory(this.video.play, text);
            if (ok) {
              TelegramApp.notify("success");
            } else {
              this.error = "Истории доступны только в мобильном Telegram";
              TelegramApp.notify("error");
            }
          },

          loadFromHistory(item) {
            this.url = item.url;
            this.platform = PlatformRegistry.get(item.platform);
            if (this.platform) {
              TelegramApp.haptic("light");
              this.download();
            } else {
              this.error = "Платформа больше не поддерживается";
              TelegramApp.notify("error");
            }
          },

          clearHistory() {
            Storage.clear();
            this.history = [];
            TelegramApp.haptic("medium");
          },
        }));
      });

      document.addEventListener("DOMContentLoaded", () => Icons.refresh());
    </script>
  </body>
</html>