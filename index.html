<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="color-scheme" content="light dark">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.14.8/dist/cdn.min.js"></script>
    <style type="text/tailwindcss">
        @theme {
            --color-tg-bg: var(--tg-theme-bg-color, #0a0a0a);
            --color-tg-text: var(--tg-theme-text-color, #fafafa);
            --color-tg-hint: var(--tg-theme-hint-color, #6b6b6b);
            --color-tg-link: var(--tg-theme-link-color, #5ebbff);
            --color-tg-btn: var(--tg-theme-button-color, #5ebbff);
            --color-tg-btn-text: var(--tg-theme-button-text-color, #ffffff);
            --color-tg-sec: var(--tg-theme-secondary-bg-color, #161616);
            --color-pink: #fe2c55;
            --color-cyan: #25f4ee;
        }

        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
        
        html, body { 
            background: var(--tg-theme-bg-color, #0a0a0a);
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', system-ui, sans-serif;
            overscroll-behavior: none;
        }

        body { padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left); }

        .grad { background: linear-gradient(135deg, #25f4ee, #fe2c55); }
        .grad-text { background: linear-gradient(135deg, #25f4ee, #fe2c55); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .glass { background: rgba(255,255,255,0.03); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); }
        
        .press { transition: transform 80ms ease, opacity 80ms ease; }
        .press:active { transform: scale(0.97); opacity: 0.85; }
        
        @keyframes fade { from { opacity: 0; transform: translateY(12px); } }
        .fade { animation: fade 0.4s cubic-bezier(0.16, 1, 0.3, 1) backwards; }
        
        .hide-scroll { scrollbar-width: none; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    </style>
</head>
<body x-data="App" class="min-h-dvh flex flex-col text-tg-text">
    
    <main class="flex-1 flex flex-col p-4 pb-28 max-w-md mx-auto w-full">
        
        <header class="text-center pt-6 pb-8 fade">
            <h1 class="text-4xl font-extrabold tracking-tight mb-1">
                <span class="grad-text">Clipper</span>
            </h1>
            <p class="text-tg-hint text-sm" x-text="statusText"></p>
        </header>

        <section class="space-y-3 fade" style="animation-delay:50ms">
            <div class="relative">
                <input 
                    type="url"
                    x-model="url"
                    @input.debounce.100ms="detect"
                    @paste="$nextTick(detect)"
                    :disabled="loading"
                    inputmode="url"
                    autocomplete="off"
                    spellcheck="false"
                    placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É..."
                    class="w-full h-[52px] px-4 pr-11 rounded-xl bg-tg-sec text-tg-text placeholder:text-tg-hint border border-white/5 outline-none focus:border-tg-btn/50 transition-colors disabled:opacity-40"
                >
                <button 
                    x-show="url" 
                    x-transition.opacity.duration.150ms
                    @click="clear"
                    class="absolute right-2 top-1/2 -translate-y-1/2 w-8 h-8 rounded-lg bg-white/5 grid place-items-center press"
                >
                    <svg class="w-4 h-4 text-tg-hint" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24">
                        <path stroke-linecap="round" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>

            <button 
                x-show="platform && !loading"
                x-transition.opacity.duration.200ms
                @click="download"
                class="w-full h-[52px] rounded-xl grad text-white font-semibold flex items-center justify-center gap-2.5 press shadow-lg shadow-pink/20"
            >
                <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3"/>
                </svg>
                <span>–°–∫–∞—á–∞—Ç—å –∏–∑ TikTok</span>
            </button>
        </section>

        <template x-if="loading">
            <section class="flex-1 flex flex-col items-center justify-center py-16 fade">
                <div class="relative w-20 h-20 mb-5">
                    <svg class="w-full h-full -rotate-90" viewBox="0 0 100 100">
                        <circle cx="50" cy="50" r="40" fill="none" stroke-width="8" class="stroke-white/10"/>
                        <circle cx="50" cy="50" r="40" fill="none" stroke-width="8" stroke-linecap="round" class="stroke-pink transition-all duration-200" :stroke-dasharray="251" :stroke-dashoffset="251 - 251 * progress / 100"/>
                    </svg>
                    <span class="absolute inset-0 grid place-items-center text-lg font-bold" x-text="progress + '%'"></span>
                </div>
                <p class="text-tg-hint text-sm" x-text="loadingText"></p>
            </section>
        </template>

        <template x-if="error">
            <section class="mt-5 p-4 rounded-xl bg-red-500/10 border border-red-500/20 fade">
                <div class="flex gap-3">
                    <div class="w-10 h-10 rounded-full bg-red-500/20 grid place-items-center shrink-0">
                        <svg class="w-5 h-5 text-red-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path stroke-linecap="round" d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z"/>
                        </svg>
                    </div>
                    <div>
                        <p class="font-medium text-red-400 mb-0.5">–û—à–∏–±–∫–∞</p>
                        <p class="text-sm text-tg-hint" x-text="error"></p>
                    </div>
                </div>
            </section>
        </template>

        <template x-if="video && !loading">
            <section class="mt-5 space-y-3 fade">
                <div class="rounded-2xl overflow-hidden bg-black border border-white/5">
                    <div class="relative aspect-[9/16] max-h-[58dvh]">
                        <video :src="video.play" :poster="video.cover" class="w-full h-full object-contain" controls playsinline></video>
                        <span class="absolute top-2.5 right-2.5 px-2.5 py-1 rounded-lg bg-black/70 glass text-white text-xs font-medium" x-text="fmt.time(video.duration)"></span>
                    </div>
                </div>

                <div class="flex items-center gap-3 p-3.5 rounded-xl bg-tg-sec/60 border border-white/5">
                    <img :src="video.author.avatar" class="w-11 h-11 rounded-full object-cover ring-1 ring-white/10">
                    <div class="flex-1 min-w-0">
                        <p class="font-semibold truncate" x-text="video.author.nickname"></p>
                        <p class="text-sm text-tg-hint truncate" x-text="'@' + video.author.unique_id"></p>
                    </div>
                </div>

                <p x-show="video.title" class="text-sm text-tg-text/80 clamp-2 px-1" x-text="video.title"></p>

                <div class="grid grid-cols-4 gap-1.5 text-center p-2.5 rounded-xl bg-tg-sec/40">
                    <template x-for="s in [['play_count','‚ñ∂'],['digg_count','‚ô•'],['comment_count','üí¨'],['share_count','‚Üó']]">
                        <div>
                            <p class="font-bold text-sm" x-text="fmt.num(video[s[0]])"></p>
                            <p class="text-[10px] text-tg-hint mt-0.5" x-text="s[1]"></p>
                        </div>
                    </template>
                </div>

                <div class="grid grid-cols-2 gap-2.5 pt-1">
                    <button @click="save" class="h-12 rounded-xl bg-tg-btn text-tg-btn-text font-semibold flex items-center justify-center gap-2 press">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3"/>
                        </svg>
                        –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                    </button>
                    <button @click="shareStory" class="h-12 rounded-xl grad text-white font-semibold flex items-center justify-center gap-2 press">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15"/>
                        </svg>
                        –ò—Å—Ç–æ—Ä–∏—è
                    </button>
                </div>
            </section>
        </template>

        <template x-if="history.length && !loading">
            <section class="mt-7 fade">
                <div class="flex items-center justify-between mb-3">
                    <h2 class="font-semibold">–ù–µ–¥–∞–≤–Ω–∏–µ</h2>
                    <button @click="clearHistory" class="text-sm text-tg-link press">–û—á–∏—Å—Ç–∏—Ç—å</button>
                </div>
                <div class="flex gap-2.5 overflow-x-auto -mx-4 px-4 pb-2 hide-scroll">
                    <template x-for="h in history" :key="h.id">
                        <button @click="fromHistory(h)" class="shrink-0 w-20 press">
                            <div class="w-20 h-28 rounded-xl overflow-hidden ring-1 ring-white/10 mb-1.5 relative">
                                <img :src="h.cover" class="w-full h-full object-cover" loading="lazy">
                                <div class="absolute inset-x-0 bottom-0 h-1/2 bg-gradient-to-t from-black/80 to-transparent"></div>
                            </div>
                            <p class="text-[11px] text-tg-hint truncate" x-text="h.author"></p>
                        </button>
                    </template>
                </div>
            </section>
        </template>

        <footer class="mt-auto pt-10 fade" style="animation-delay:100ms" x-show="!loading && !video">
            <p class="text-center text-xs text-tg-hint mb-4">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã</p>
            <div class="flex justify-center gap-3">
                <div class="flex items-center gap-2 px-4 py-2.5 rounded-xl bg-tg-sec border border-white/5">
                    <svg class="w-5 h-5 text-pink" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19.59 6.69a4.83 4.83 0 01-3.77-4.25V2h-3.45v13.67a2.89 2.89 0 01-5.2 1.74 2.89 2.89 0 012.31-4.64c.29 0 .58.04.88.13V9.4c-.29-.03-.6-.05-1-.05A6.33 6.33 0 005 20.1a6.34 6.34 0 0010.86-4.43v-7a8.16 8.16 0 004.77 1.52v-3.4a4.85 4.85 0 01-1.04-.1z"/>
                    </svg>
                    <span class="text-sm font-medium">TikTok</span>
                </div>
                <div class="flex items-center gap-2 px-4 py-2.5 rounded-xl bg-tg-sec border border-white/5 opacity-40">
                    <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zM12 0C8.741 0 8.333.014 7.053.072 2.695.272.273 2.69.073 7.052.014 8.333 0 8.741 0 12c0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98C8.333 23.986 8.741 24 12 24c3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98C15.668.014 15.259 0 12 0zm0 5.838a6.162 6.162 0 100 12.324 6.162 6.162 0 000-12.324zM12 16a4 4 0 110-8 4 4 0 010 8zm6.406-11.845a1.44 1.44 0 100 2.881 1.44 1.44 0 000-2.881z"/>
                    </svg>
                    <span class="text-sm font-medium">Instagram</span>
                    <span class="text-[10px] text-tg-hint">—Å–∫–æ—Ä–æ</span>
                </div>
            </div>
        </footer>
    </main>

    <script>
    const TG = {
        app: window.Telegram?.WebApp,
        
        init() {
            if (!this.app) return;
            this.app.ready();
            this.app.expand();
            this.app.setHeaderColor('secondary_bg_color');
            this.app.setBackgroundColor('secondary_bg_color');
        },
        
        haptic(type = 'light') {
            this.app?.HapticFeedback?.impactOccurred(type);
        },
        
        notify(type) {
            this.app?.HapticFeedback?.notificationOccurred(type);
        },
        
        story(url) {
            if (!this.app?.shareToStory) return false;
            this.app.shareToStory(url, { widget_link: { url: 'https://t.me/clipper', name: 'Clipper' } });
            return true;
        }
    };

    class TikTokAPI {
        static URL = 'https://www.tikwm.com/api/';
        static PATTERNS = [
            /tiktok\.com\/@[\w.]+\/video\/(\d+)/i,
            /tiktok\.com\/t\/([\w]+)/i,
            /vm\.tiktok\.com\/([\w]+)/i,
            /vt\.tiktok\.com\/([\w]+)/i
        ];

        static match(url) {
            return this.PATTERNS.some(p => p.test(url));
        }

        static async fetch(url) {
            const res = await fetch(this.URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: new URLSearchParams({ url, hd: 1 })
            });
            
            const json = await res.json();
            if (json.code !== 0) throw new Error(json.msg || '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –≤–∏–¥–µ–æ');
            return json.data;
        }
    }

    class Storage {
        static KEY = 'clipper_history';
        static MAX = 15;

        static get() {
            try { return JSON.parse(localStorage.getItem(this.KEY)) || []; }
            catch { return []; }
        }

        static add(item) {
            const list = this.get().filter(i => i.id !== item.id);
            list.unshift(item);
            localStorage.setItem(this.KEY, JSON.stringify(list.slice(0, this.MAX)));
        }

        static clear() {
            localStorage.removeItem(this.KEY);
        }
    }

    document.addEventListener('alpine:init', () => {
        Alpine.data('App', () => ({
            url: '',
            platform: null,
            loading: false,
            progress: 0,
            video: null,
            error: null,
            history: Storage.get(),

            fmt: {
                num: n => n >= 1e6 ? (n/1e6).toFixed(1)+'M' : n >= 1e3 ? (n/1e3).toFixed(1)+'K' : String(n || 0),
                time: s => `${Math.floor(s/60)}:${String(s%60).padStart(2,'0')}`
            },

            get statusText() {
                if (this.loading) return '–ó–∞–≥—Ä—É–∑–∫–∞...';
                if (this.platform) return 'TikTok –≤–∏–¥–µ–æ –Ω–∞–π–¥–µ–Ω–æ';
                return '–°–∫–∞—á–∏–≤–∞–π—Ç–µ –≤–∏–¥–µ–æ –±–µ–∑ –≤–æ–¥—è–Ω—ã—Ö –∑–Ω–∞–∫–æ–≤';
            },

            get loadingText() {
                if (this.progress < 30) return '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...';
                if (this.progress < 70) return '–ü–æ–ª—É—á–µ–Ω–∏–µ –≤–∏–¥–µ–æ...';
                return '–ü–æ—á—Ç–∏ –≥–æ—Ç–æ–≤–æ...';
            },

            init() {
                TG.init();
            },

            detect() {
                this.error = null;
                this.platform = TikTokAPI.match(this.url) ? 'tiktok' : null;
                if (this.platform) TG.haptic('light');
            },

            clear() {
                this.url = '';
                this.platform = null;
                this.video = null;
                this.error = null;
                TG.haptic('light');
            },

            async download() {
                if (!this.platform || this.loading) return;
                
                this.loading = true;
                this.progress = 0;
                this.error = null;
                this.video = null;
                TG.haptic('medium');

                const tick = setInterval(() => {
                    this.progress = Math.min(this.progress + Math.random() * 12, 90);
                }, 150);

                try {
                    this.video = await TikTokAPI.fetch(this.url);
                    this.progress = 100;
                    
                    Storage.add({
                        id: this.video.id,
                        cover: this.video.cover,
                        author: this.video.author.nickname,
                        url: this.url
                    });
                    this.history = Storage.get();
                    TG.notify('success');
                } catch (e) {
                    this.error = e.message || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞';
                    TG.notify('error');
                } finally {
                    clearInterval(tick);
                    this.loading = false;
                }
            },

            save() {
                if (!this.video?.play) return;
                const a = document.createElement('a');
                a.href = this.video.play;
                a.download = `tiktok_${this.video.id}.mp4`;
                a.target = '_blank';
                a.click();
                TG.notify('success');
            },

            shareStory() {
                if (!this.video?.play) return;
                if (!TG.story(this.video.play)) {
                    this.error = '–ò—Å—Ç–æ—Ä–∏–∏ –¥–æ—Å—Ç—É–ø–Ω—ã –≤ –º–æ–±–∏–ª—å–Ω–æ–º Telegram';
                }
            },

            fromHistory(h) {
                this.url = h.url;
                this.detect();
                TG.haptic('light');
            },

            clearHistory() {
                Storage.clear();
                this.history = [];
                TG.haptic('medium');
            }
        }));
    });
    </script>
</body>
</html>